// courses-analytics-dashboard.js
class CoursesAnalyticsDashboard {
    constructor() {
        this.metrics = {};
        this.charts = {};
        this.alerts = [];
        this.initializeDashboard();
    }
    
    initializeDashboard() {
        this.createDashboardInterface();
        this.startMetricsCollection();
        this.initializeCharts();
        this.setupAlertSystem();
    }
    
    createDashboardInterface() {
        const dashboardHTML = `
        <div class="courses-analytics-dashboard" id="courses-analytics-dashboard">
            <div class="dashboard-header">
                <h3>üìä Courses Module Analytics</h3>
                <div class="dashboard-controls">
                    <button id="refresh-analytics">üîÑ Refresh</button>
                    <button id="export-analytics">üì§ Export</button>
                    <button id="toggle-realtime">‚è∏Ô∏è Realtime</button>
                </div>
            </div>
            
            <div class="metrics-overview">
                <div class="metric-card">
                    <div class="metric-value" id="total-courses">0</div>
                    <div class="metric-label">Total Courses</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="active-users">0</div>
                    <div class="metric-label">Active Users</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="completion-rate">0%</div>
                    <div class="metric-label">Completion Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avg-engagement">0m</div>
                    <div class="metric-label">Avg Engagement</div>
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-container">
                    <h4>Course Engagement Over Time</h4>
                    <canvas id="engagement-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Module Interaction Flow</h4>
                    <div id="interaction-flow-chart"></div>
                </div>
                <div class="chart-container">
                    <h4>User Progress Distribution</h4>
                    <canvas id="progress-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>System Performance</h4>
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>
            
            <div class="alerts-section">
                <h4>üö® System Alerts</h4>
                <div class="alerts-container" id="alerts-container"></div>
            </div>
            
            <div class="interaction-logs">
                <h4>üìù Recent Interactions</h4>
                <div class="logs-container" id="interaction-logs-container"></div>
            </div>
        </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', dashboardHTML);
    }
    
    startMetricsCollection() {
        setInterval(async () => {
            try {
                const metrics = await this.fetchComprehensiveMetrics();
                this.updateAllDisplays(metrics);
                this.checkAlerts(metrics);
                this.updateCharts(metrics);
            } catch (error) {
                console.error('Metrics collection failed:', error);
            }
        }, 5000); // Update every 5 seconds
    }
    
    async fetchComprehensiveMetrics() {
        const endpoints = [
            '/api/courses/metrics/overview/',
            '/api/courses/metrics/interactions/',
            '/api/courses/metrics/performance/',
            '/api/courses/metrics/engagement/'
        ];
        
        const requests = endpoints.map(url => fetch(url).then(r => r.json()));
        const results = await Promise.all(requests);
        
        return this.mergeMetrics(results);
    }
}