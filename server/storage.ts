import { 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type User, 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUser, 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Course,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Module,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Lesson,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserCourse,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserLesson,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Assignment,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserAssignment,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Badge,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserBadge,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type CourseRecommendation,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type LearningPath,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type LearningPathStep,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertLearningPath,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertLearningPathStep,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Analytics types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserActivityLog,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserActivityLog,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type CourseAnalytic,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertCourseAnalytic,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserProgressSnapshot,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserProgressSnapshot,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Adaptive Learning Reward System types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Challenge,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertChallenge,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserChallenge,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserChallenge,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserLevel,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserLevel,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Achievement types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Achievement,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertAchievement,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserAchievement,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserAchievement,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Interactive lesson trails types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type LessonTrail,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertLessonTrail,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type TrailNode,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertTrailNode,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserTrailProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserTrailProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type PersonalizedRecommendation,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertPersonalizedRecommendation,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type LearningAnalytics,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertLearningAnalytics,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Leaderboard types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Leaderboard,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertLeaderboard,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type LeaderboardEntry,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertLeaderboardEntry,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertCourseSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertModuleSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertLessonSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserCourseSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserLessonSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertAssignmentSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserAssignmentSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertBadgeSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserBadgeSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertCourseRecommendationSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertLearningPathSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertLearningPathStepSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Analytics schemas

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserActivityLogSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertCourseAnalyticsSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserProgressSnapshotSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Adaptive Learning Reward System schemas

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertChallengeSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserChallengeSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserLevelSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  users,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  courses,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  modules,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  lessons,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userCourses,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userLessons,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  assignments,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userAssignments,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  badges,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userBadges,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  courseRecommendations,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  learningPaths,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  learningPathSteps,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Analytics tables

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userActivityLogs,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  courseAnalytics,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userProgressSnapshots,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Adaptive Learning Reward System tables

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  challenges,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userChallenges,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userLevels,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Achievements and Leaderboards tables

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  achievements,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userAchievements,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  leaderboards,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  leaderboardEntries,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Interactive lesson trails tables

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  lessonTrails,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  trailNodes,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userTrailProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  personalizedRecommendations,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  learningAnalytics,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  learningMilestones,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  emojiReactions,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type LearningMilestone,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertLearningMilestone,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type EmojiReaction,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertEmojiReaction,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Course category types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type CourseCategory,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertCourseCategory,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  courseCategories,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertCourseCategorySchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Mentor and Program types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Mentor,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertMentor,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserMentor,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserMentor,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type StudyProgram,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertStudyProgram,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type ProgramSchedule,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertProgramSchedule,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserProgramProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserProgramProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type StudySession,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertStudySession,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Assessment system types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type LevelAssessment,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertLevelAssessment,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type AssessmentQuestion,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertAssessmentQuestion,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserSkillLevel,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserSkillLevel,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  mentors,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userMentors,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  studyPrograms,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  programSchedules,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userProgramProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  studySessions,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertMentorSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserMentorSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertStudyProgramSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertProgramScheduleSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserProgramProgressSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertStudySessionSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  studyGoals,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  studySchedules,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  learningRecommendations,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  studyProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  levelAssessments,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  assessmentQuestions,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userSkillLevels,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertLevelAssessment,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertAssessmentQuestion,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserSkillLevel,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // TYT Study Planning system imports

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type TytStudentProfile,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type TytSubject,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type TytTopic,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserTopicProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type TytTrialExam,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type DailyStudyTask,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type TytStudySession,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type TytStudyGoal,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type TytStudyStreak,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertTytStudentProfile,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertTytSubject,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertTytTopic,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserTopicProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertTytTrialExam,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertDailyStudyTask,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertTytStudySession,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertTytStudyGoal,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertTytStudyStreak,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  tytStudentProfiles,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  tytSubjects,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  tytTopics,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userTopicProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  tytTrialExams,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  dailyStudyTasks,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  tytStudySessions,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  tytStudyGoals,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  tytStudyStreaks,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertTytStudentProfileSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertTytSubjectSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertTytTopicSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserTopicProgressSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertTytTrialExamSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertDailyStudyTaskSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertTytStudySessionSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertTytStudyGoalSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertTytStudyStreakSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // New Time Tracking & Analytics types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type DailyStudyGoal,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type StudyHabit,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type TytResource,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type AiDailyPlan,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertDailyStudyGoal,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertStudyHabit,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertTytResource,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertAiDailyPlan,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  dailyStudyGoals,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  studyHabits,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  tytResources,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  aiDailyPlans,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertDailyStudyGoalSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertStudyHabitSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertTytResourceSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertAiDailyPlanSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // AI Curriculum System types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type CourseCurriculum,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertCourseCurriculum,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type CurriculumSkill,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertCurriculumSkill,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type CurriculumModule,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertCurriculumModule,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserCurriculum,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserCurriculum,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserCurriculumTask,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserCurriculumTask,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type UserSkillProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUserSkillProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type CurriculumCheckpoint,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertCurriculumCheckpoint,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type SkillAssessment,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertSkillAssessment,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  courseCurriculums,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  curriculumSkills,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  curriculumModules,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userCurriculums,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userCurriculumTasks,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  userSkillProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  curriculumCheckpoints,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  skillAssessments,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertCourseCurriculumSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertCurriculumSkillSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertCurriculumModuleSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserCurriculumSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserCurriculumTaskSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUserSkillProgressSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertCurriculumCheckpointSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertSkillAssessmentSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // New feature tables

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Upload,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertUpload,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Essay,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertEssay,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type WeeklyStudyPlan,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertWeeklyStudyPlan,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  uploads,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  essays,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  weeklyStudyPlans,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertUploadSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertEssaySchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertWeeklyStudyPlanSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Daily Study Sessions

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type DailyStudySession,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertDailyStudySession,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  dailyStudySessions,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertDailyStudySessionSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Forum System types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type ForumPost,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertForumPost,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type ForumComment,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertForumComment,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  forumPosts,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  forumComments,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertForumPostSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertForumCommentSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Certificate System types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type Certificate,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertCertificate,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  certificates,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertCertificateSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // AI Logging types

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type AiConceptLog,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertAiConceptLog,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type AiStudyTipsLog,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertAiStudyTipsLog,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type AiReviewLog,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertAiReviewLog,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  aiConceptLogs,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  aiStudyTipsLogs,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  aiReviewLogs,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertAiConceptLogSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertAiStudyTipsLogSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertAiReviewLogSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Step 6.1: AI Data Flow types & tables

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type AiCurriculumGenerationSession,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type CurriculumProductionArchive,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type AiLearningDataRecord,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertAiCurriculumGenerationSession,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertCurriculumProductionArchive,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  type InsertAiLearningData,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  aiCurriculumGenerationSessions,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  curriculumProductionArchives,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  aiLearningData,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertAiCurriculumGenerationSessionSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertCurriculumProductionArchiveSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  insertAiLearningDataSchema,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  curriculumFeedbackLoops,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
} from "@shared/schema";

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
import { z } from "zod";

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
import { db } from "./db";

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
import { eq, and, or, desc, inArray, asc, sql } from "drizzle-orm";

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
import session from "express-session";

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
import connectPg from "connect-pg-simple";

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
import { pool } from "./db";

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
// Define insert types based on the schemas

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertCourse = z.infer<typeof insertCourseSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertModule = z.infer<typeof insertModuleSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertLesson = z.infer<typeof insertLessonSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertUserCourse = z.infer<typeof insertUserCourseSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertUserLesson = z.infer<typeof insertUserLessonSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertAssignment = z.infer<typeof insertAssignmentSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertUserAssignment = z.infer<typeof insertUserAssignmentSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertBadge = z.infer<typeof insertBadgeSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertUserBadge = z.infer<typeof insertUserBadgeSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertCourseRecommendation = z.infer<typeof insertCourseRecommendationSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
// New insert types for mentor and program systems

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertMentorType = z.infer<typeof insertMentorSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertUserMentorType = z.infer<typeof insertUserMentorSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertStudyProgramType = z.infer<typeof insertStudyProgramSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertProgramScheduleType = z.infer<typeof insertProgramScheduleSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertUserProgramProgressType = z.infer<typeof insertUserProgramProgressSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type InsertStudySessionType = z.infer<typeof insertStudySessionSchema>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
const PostgresSessionStore = connectPg(session);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
// Define SessionStore type

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
type SessionStore = session.Store;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
// Interface for storage operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
export interface IStorage {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUser(id: number): Promise<User | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserById(id: number): Promise<User | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserByUsername(username: string): Promise<User | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createUser(user: InsertUser): Promise<User>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUser(id: number, data: Partial<User>): Promise<User | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserInterests(userId: number, interests: string[]): Promise<User | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Course operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCourses(): Promise<Course[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCourse(id: number): Promise<Course | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createCourse(course: InsertCourse): Promise<Course>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateCourse(id: number, data: Partial<Course>): Promise<Course | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getAiGeneratedCourses(): Promise<Course[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Course category operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCategories(): Promise<CourseCategory[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCategory(id: number): Promise<CourseCategory | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createCategory(category: InsertCourseCategory): Promise<CourseCategory>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateCategory(id: number, data: Partial<CourseCategory>): Promise<CourseCategory | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  deleteCategory(id: number): Promise<boolean>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCategoryTree(): Promise<CourseCategory[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCoursesInCategory(categoryId: number): Promise<Course[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Module operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getModules(courseId: number): Promise<Module[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createModule(module: InsertModule): Promise<Module>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Lesson operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getLessons(moduleId: number): Promise<Lesson[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createLesson(lesson: InsertLesson): Promise<Lesson>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // UserCourse operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserCourses(userId: number): Promise<(UserCourse & { course: Course })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  enrollUserInCourse(userCourse: InsertUserCourse): Promise<UserCourse>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserCourseProgress(id: number, progress: number): Promise<UserCourse | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // UserLesson operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserLessons(userId: number): Promise<(UserLesson & { lesson: Lesson })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserLessonProgress(userId: number, lessonId: number, progress: number): Promise<UserLesson>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Assignment operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getAssignments(): Promise<Assignment[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserAssignments(userId: number): Promise<(Assignment & { course: Course })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createAssignment(assignment: InsertAssignment): Promise<Assignment>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Badge operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getBadges(): Promise<Badge[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserBadges(userId: number): Promise<(UserBadge & { badge: Badge })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  awardBadgeToUser(userBadge: InsertUserBadge): Promise<UserBadge>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Course recommendation operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCourseRecommendations(userId: number): Promise<CourseRecommendation | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  saveCourseRecommendations(userId: number, recommendations: any): Promise<CourseRecommendation>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Learning path operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getLearningPaths(userId: number): Promise<LearningPath[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserLearningPaths(userId: number): Promise<LearningPath[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getLearningPath(id: number): Promise<(LearningPath & { steps: (LearningPathStep & { course: Course })[] }) | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createLearningPath(path: InsertLearningPath): Promise<LearningPath>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  addLearningPathStep(step: InsertLearningPathStep): Promise<LearningPathStep>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateLearningPathProgress(id: number, progress: number): Promise<LearningPath | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateLearningPath(id: number, data: Partial<LearningPath>): Promise<LearningPath | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  deleteLearningPath(id: number): Promise<boolean>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  markStepAsCompleted(id: number): Promise<LearningPathStep | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  generateLearningPath(userId: number, goal: string): Promise<LearningPath>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  generateAndSyncCurriculum(userId: number, courseId: number): Promise<any>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Analytics operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  logUserActivity(activity: InsertUserActivityLog): Promise<UserActivityLog>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserActivities(userId: number, limit?: number): Promise<UserActivityLog[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserActivityByTimeframe(userId: number, startDate: Date, endDate: Date): Promise<UserActivityLog[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Course analytics operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCourseAnalytics(courseId: number): Promise<CourseAnalytic | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateCourseAnalytics(courseId: number, data: Partial<InsertCourseAnalytic>): Promise<CourseAnalytic>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getPopularCourses(limit?: number): Promise<(CourseAnalytic & { course: Course })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User progress operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserProgressSnapshot(userId: number, date?: Date): Promise<UserProgressSnapshot | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createUserProgressSnapshot(data: InsertUserProgressSnapshot): Promise<UserProgressSnapshot>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserProgressOverTime(userId: number, startDate: Date, endDate: Date): Promise<UserProgressSnapshot[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getPlatformStats(): Promise<{

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    totalUsers: number,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    totalCourses: number,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    totalLessonsCompleted: number,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    totalAssignmentsCompleted: number,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    averageGrade: number

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Adaptive Learning Reward System operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Challenge operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getChallenges(filters?: { type?: string; active?: boolean; category?: string }): Promise<Challenge[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getChallenge(id: number): Promise<Challenge | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createChallenge(challenge: InsertChallenge): Promise<Challenge>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateChallenge(id: number, data: Partial<Challenge>): Promise<Challenge | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  deactivateChallenge(id: number): Promise<Challenge | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCourseRelatedChallenges(courseId: number): Promise<Challenge[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User challenge operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserChallenges(userId: number): Promise<(UserChallenge & { challenge: Challenge })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserActiveAndCompletedChallenges(userId: number): Promise<{

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    active: (UserChallenge & { challenge: Challenge })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    completed: (UserChallenge & { challenge: Challenge })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  assignChallengeToUser(userId: number, challengeId: number): Promise<UserChallenge>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserChallengeProgress(userId: number, challengeId: number, progress: number): Promise<UserChallenge | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  completeUserChallenge(userId: number, challengeId: number): Promise<UserChallenge | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User level operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserLevel(userId: number): Promise<UserLevel | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  initializeUserLevel(userId: number): Promise<UserLevel>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  addUserXp(userId: number, xpAmount: number): Promise<UserLevel | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  addUserPoints(userId: number, pointsAmount: number): Promise<UserLevel | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserStreak(userId: number): Promise<UserLevel | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  resetUserStreak(userId: number): Promise<UserLevel | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Achievement operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getAchievements(filters?: { category?: string; rarity?: string; }): Promise<Achievement[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getAchievement(id: number): Promise<Achievement | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createAchievement(achievement: InsertAchievement): Promise<Achievement>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserAchievements(userId: number): Promise<(UserAchievement & { achievement: Achievement })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  awardAchievementToUser(userId: number, achievementId: number): Promise<UserAchievement>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  unlockUserAchievement(userId: number, achievementId: number): Promise<UserAchievement>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Statistics for achievement checking

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserCompletedChallengesCount(userId: number): Promise<number>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserCompletedCoursesCount(userId: number): Promise<number>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Leaderboard operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getLeaderboards(filters?: { type?: string; timeframe?: string; }): Promise<Leaderboard[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getLeaderboard(id: number): Promise<(Leaderboard & { entries: (LeaderboardEntry & { user: User })[] }) | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createLeaderboard(leaderboard: InsertLeaderboard): Promise<Leaderboard>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateLeaderboardEntry(userId: number, leaderboardId: number, score: number): Promise<LeaderboardEntry>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getLeaderboardEntries(leaderboardId: number, limit?: number): Promise<(LeaderboardEntry & { user: User })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserRankings(userId: number): Promise<(LeaderboardEntry & { leaderboard: Leaderboard })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Social media operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getSocialFeed(userId: number, limit?: number): Promise<any[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createSocialPost(post: { userId: number; type: string; content: string; data?: any }): Promise<any>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  togglePostLike(postId: number, userId: number): Promise<{ liked: boolean; likeCount: number }>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserSocialProfile(userId: number): Promise<any>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  toggleUserFollow(followerId: number, followingId: number, action: string): Promise<{ following: boolean; followerCount: number }>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTrendingTopics(): Promise<any[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  checkAndUnlockAchievements(userId: number): Promise<Achievement[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Mentor system operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getMentors(filters?: { isAiMentor?: boolean; isActive?: boolean; specialization?: string }): Promise<(Mentor & { user: User })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getMentor(id: number): Promise<(Mentor & { user: User }) | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createMentor(mentor: InsertMentor): Promise<Mentor>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateMentor(id: number, data: Partial<Mentor>): Promise<Mentor | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  assignMentorToUser(studentId: number, mentorId: number, options?: { preferredCommunication?: string; communicationLanguage?: string; notes?: string }): Promise<UserMentor>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserMentor(studentId: number): Promise<(UserMentor & { mentor: Mentor & { user: User } }) | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserMentor(id: number, data: Partial<UserMentor>): Promise<UserMentor | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  autoAssignMentor(studentId: number): Promise<UserMentor>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study program operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getStudyPrograms(filters?: { targetGroup?: string; isActive?: boolean }): Promise<(StudyProgram & { creator: User })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getStudyProgram(id: number): Promise<(StudyProgram & { creator: User; schedules: ProgramSchedule[] }) | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createStudyProgram(program: InsertStudyProgram): Promise<StudyProgram>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateStudyProgram(id: number, data: Partial<StudyProgram>): Promise<StudyProgram | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserStudyPrograms(userId: number): Promise<(UserProgramProgress & { program: StudyProgram })[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  enrollUserInProgram(userId: number, programId: number): Promise<UserProgramProgress>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserProgramProgress(userId: number, programId: number, data: Partial<UserProgramProgress>): Promise<UserProgramProgress | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Program schedule operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getProgramSchedules(programId: number, week?: number): Promise<ProgramSchedule[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createProgramSchedule(schedule: InsertProgramSchedule): Promise<ProgramSchedule>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateProgramSchedule(id: number, data: Partial<ProgramSchedule>): Promise<ProgramSchedule | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study session operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getStudySessions(userId: number, filters?: { programId?: number; startDate?: Date; endDate?: Date }): Promise<StudySession[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createStudySession(session: InsertStudySession): Promise<StudySession>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateStudySession(id: number, data: Partial<StudySession>): Promise<StudySession | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserWeeklyStats(userId: number, programId?: number): Promise<{ plannedHours: number; actualHours: number; adherenceScore: number }>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Level Assessment operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createLevelAssessment(assessment: InsertLevelAssessment): Promise<number>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getLevelAssessment(id: number): Promise<LevelAssessment | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateLevelAssessment(id: number, data: Partial<LevelAssessment>): Promise<LevelAssessment | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserAssessments(userId: number): Promise<LevelAssessment[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Assessment Question operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createAssessmentQuestion(question: InsertAssessmentQuestion): Promise<AssessmentQuestion>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getAssessmentQuestions(assessmentId: number): Promise<AssessmentQuestion[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateAssessmentQuestion(id: number, data: Partial<AssessmentQuestion>): Promise<AssessmentQuestion | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Skill Level operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserSkillLevels(userId: number): Promise<UserSkillLevel[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserSkillLevel(userId: number, subject: string, subCategory?: string): Promise<UserSkillLevel | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserSkillLevel(userId: number, skillData: InsertUserSkillLevel): Promise<UserSkillLevel>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // TYT Study Planning System operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Student Profile operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytStudentProfile(userId: number): Promise<TytStudentProfile | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createTytStudentProfile(profile: InsertTytStudentProfile): Promise<TytStudentProfile>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateTytStudentProfile(userId: number, data: Partial<TytStudentProfile>): Promise<TytStudentProfile | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Subject and Topic operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytSubjects(): Promise<TytSubject[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytSubject(id: number): Promise<TytSubject | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createTytSubject(subject: InsertTytSubject): Promise<TytSubject>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytTopics(subjectId?: number): Promise<TytTopic[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytTopic(id: number): Promise<TytTopic | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createTytTopic(topic: InsertTytTopic): Promise<TytTopic>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Topic Progress operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserTopicProgress(userId: number, topicId?: number): Promise<UserTopicProgress[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserTopicProgress(userId: number, topicId: number, data: Partial<UserTopicProgress>): Promise<UserTopicProgress>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createUserTopicProgress(progress: InsertUserTopicProgress): Promise<UserTopicProgress>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Trial Exam operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytTrialExams(userId: number): Promise<TytTrialExam[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytTrialExam(id: number): Promise<TytTrialExam | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createTytTrialExam(exam: InsertTytTrialExam): Promise<TytTrialExam>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  deleteTytTrialExam(id: number): Promise<boolean>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Daily Study Task operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getDailyStudyTasks(userId: number, date?: string): Promise<DailyStudyTask[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getDailyStudyTask(id: number): Promise<DailyStudyTask | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createDailyStudyTask(task: InsertDailyStudyTask): Promise<DailyStudyTask>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateDailyStudyTask(id: number, data: Partial<DailyStudyTask>): Promise<DailyStudyTask | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  deleteDailyStudyTask(id: number): Promise<boolean>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  completeDailyStudyTask(id: number, actualDuration?: number): Promise<DailyStudyTask | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCurriculumContextForDailyTasks(userId: number, taskIds: number[]): Promise<Map<number, {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    curriculumTaskId: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    curriculumId: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    curriculumTitleEn: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    curriculumTitleTr: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    skillName: string | null;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    taskTitleEn: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    taskTitleTr: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }>>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study Session operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytStudySessions(userId: number, filters?: { startDate?: Date; endDate?: Date; subjectId?: number }): Promise<TytStudySession[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytStudySession(id: number): Promise<TytStudySession | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createTytStudySession(session: InsertTytStudySession): Promise<TytStudySession>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateTytStudySession(id: number, data: Partial<TytStudySession>): Promise<TytStudySession | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  endTytStudySession(id: number): Promise<TytStudySession | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study Goal operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytStudyGoals(userId: number, goalType?: string): Promise<TytStudyGoal[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytStudyGoal(id: number): Promise<TytStudyGoal | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createTytStudyGoal(goal: InsertTytStudyGoal): Promise<TytStudyGoal>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateTytStudyGoal(id: number, data: Partial<TytStudyGoal>): Promise<TytStudyGoal | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  deleteTytStudyGoal(id: number): Promise<boolean>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study Streak operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytStudyStreaks(userId: number): Promise<TytStudyStreak[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytStudyStreak(userId: number, streakType: string): Promise<TytStudyStreak | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createTytStudyStreak(streak: InsertTytStudyStreak): Promise<TytStudyStreak>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateTytStudyStreak(userId: number, streakType: string, data: Partial<TytStudyStreak>): Promise<TytStudyStreak | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Analytics and Summary operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytStudyStats(userId: number, timeframe?: 'daily' | 'weekly' | 'monthly'): Promise<{

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    totalStudyTime: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    completedTasks: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    averageNetScore: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    subjectProgress: Array<{ subject: string; progress: number; timeSpent: number }>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    streaks: Array<{ type: string; current: number; longest: number }>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // New Time Tracking & Analytics operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Daily Study Goals operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getDailyStudyGoal(userId: number, date: string): Promise<DailyStudyGoal | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getDailyStudyGoals(userId: number, startDate?: string, endDate?: string): Promise<DailyStudyGoal[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createDailyStudyGoal(goal: InsertDailyStudyGoal): Promise<DailyStudyGoal>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateDailyStudyGoal(userId: number, date: string, data: Partial<DailyStudyGoal>): Promise<DailyStudyGoal | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study Habits operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getStudyHabits(userId: number, period?: string): Promise<StudyHabit[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getStudyHabit(id: number): Promise<StudyHabit | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createStudyHabit(habit: InsertStudyHabit): Promise<StudyHabit>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Daily Study Sessions operations (Time Tracking)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getDailyStudySessions(userId: number, date?: string): Promise<DailyStudySession[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getDailyStudySession(userId: number, date: string): Promise<DailyStudySession | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createDailyStudySession(session: InsertDailyStudySession): Promise<DailyStudySession>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // TYT Resources operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytResources(topicId: number): Promise<TytResource[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getTytResource(id: number): Promise<TytResource | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createTytResource(resource: InsertTytResource): Promise<TytResource>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateTytResource(id: number, data: Partial<TytResource>): Promise<TytResource | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  deleteTytResource(id: number): Promise<boolean>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // AI Daily Plans operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getAiDailyPlan(userId: number, date: string): Promise<AiDailyPlan | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getAiDailyPlans(userId: number, startDate?: string, endDate?: string): Promise<AiDailyPlan[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createAiDailyPlan(plan: InsertAiDailyPlan): Promise<AiDailyPlan>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateAiDailyPlanProgress(userId: number, date: string, completionRate: number): Promise<AiDailyPlan | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Forum System operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getForumPosts(limit?: number, offset?: number): Promise<ForumPost[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getForumPost(id: number): Promise<ForumPost | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserForumPosts(userId: number): Promise<ForumPost[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createForumPost(post: InsertForumPost): Promise<ForumPost>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateForumPost(id: number, data: Partial<ForumPost>): Promise<ForumPost | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  deleteForumPost(id: number): Promise<boolean>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  incrementPostViews(id: number): Promise<void>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Forum Comments operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getPostComments(postId: number): Promise<ForumComment[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getForumComment(id: number): Promise<ForumComment | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createForumComment(comment: InsertForumComment): Promise<ForumComment>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateForumComment(id: number, data: Partial<ForumComment>): Promise<ForumComment | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  deleteForumComment(id: number): Promise<boolean>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Certificate System operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserCertificates(userId: number): Promise<Certificate[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCertificate(id: number): Promise<Certificate | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCertificateByNumber(certificateNumber: string): Promise<Certificate | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createCertificate(certificate: InsertCertificate): Promise<Certificate>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  verifyCertificate(verificationCode: string): Promise<Certificate | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  revokeCertificate(id: number): Promise<Certificate | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // AI Curriculum System operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Course Curriculum operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCourseCurriculum(courseId: number): Promise<CourseCurriculum | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createCourseCurriculum(curriculum: InsertCourseCurriculum): Promise<CourseCurriculum>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateCourseCurriculum(id: number, data: Partial<CourseCurriculum>): Promise<CourseCurriculum | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Curriculum Skill operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCurriculumSkills(curriculumId: number): Promise<CurriculumSkill[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCurriculumSkill(id: number): Promise<CurriculumSkill | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createCurriculumSkill(skill: InsertCurriculumSkill): Promise<CurriculumSkill>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateCurriculumSkill(id: number, data: Partial<CurriculumSkill>): Promise<CurriculumSkill | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Curriculum Module operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCurriculumModules(curriculumId: number): Promise<CurriculumModule[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCurriculumModule(id: number): Promise<CurriculumModule | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createCurriculumModule(module: InsertCurriculumModule): Promise<CurriculumModule>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateCurriculumModule(id: number, data: Partial<CurriculumModule>): Promise<CurriculumModule | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Curriculum operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserCurriculum(userId: number, courseId: number): Promise<UserCurriculum | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserCurriculums(userId: number): Promise<UserCurriculum[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createUserCurriculum(userCurriculum: InsertUserCurriculum): Promise<UserCurriculum>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserCurriculumProgress(id: number, progress: number): Promise<UserCurriculum | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Curriculum Task operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserCurriculumTasks(userCurriculumId: number): Promise<UserCurriculumTask[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserCurriculumTask(id: number): Promise<UserCurriculumTask | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createUserCurriculumTask(task: InsertUserCurriculumTask): Promise<UserCurriculumTask>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserCurriculumTask(id: number, data: Partial<UserCurriculumTask>): Promise<UserCurriculumTask | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  deleteUserCurriculumTask(id: number): Promise<boolean>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  completeUserCurriculumTask(id: number, score?: number): Promise<UserCurriculumTask | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Skill Progress operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserSkillProgress(userCurriculumId: number): Promise<UserSkillProgress[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserSkillProgressBySkill(userCurriculumId: number, skillId: number): Promise<UserSkillProgress | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createUserSkillProgress(progress: InsertUserSkillProgress): Promise<UserSkillProgress>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateUserSkillProgress(id: number, data: Partial<UserSkillProgress>): Promise<UserSkillProgress | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Curriculum Checkpoint operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCurriculumCheckpoints(curriculumId: number): Promise<CurriculumCheckpoint[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getCurriculumCheckpoint(id: number): Promise<CurriculumCheckpoint | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createCurriculumCheckpoint(checkpoint: InsertCurriculumCheckpoint): Promise<CurriculumCheckpoint>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateCurriculumCheckpoint(id: number, data: Partial<CurriculumCheckpoint>): Promise<CurriculumCheckpoint | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Skill Assessment operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getSkillAssessments(userCurriculumId: number): Promise<SkillAssessment[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getSkillAssessment(id: number): Promise<SkillAssessment | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createSkillAssessment(assessment: InsertSkillAssessment): Promise<SkillAssessment>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateSkillAssessment(id: number, data: Partial<SkillAssessment>): Promise<SkillAssessment | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Curriculum generation and task sync

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  generateAndSyncCurriculum(userId: number, courseId: number): Promise<{

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    curriculum: UserCurriculum;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    tasks: UserCurriculumTask[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    skills: CurriculumSkill[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // File Upload operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUpload(id: number): Promise<Upload | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserUploads(userId: number, uploadType?: string): Promise<Upload[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createUpload(upload: InsertUpload): Promise<Upload>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  deleteUpload(id: number): Promise<boolean>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Essay operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getEssay(id: number): Promise<Essay | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserEssays(userId: number, courseId?: number): Promise<Essay[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createEssay(essay: InsertEssay): Promise<Essay>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateEssay(id: number, data: Partial<Essay>): Promise<Essay | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  submitEssay(id: number): Promise<Essay | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  generateAiFeedback(essayId: number, content: string): Promise<string>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Weekly Study Plan operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getWeeklyStudyPlan(id: number): Promise<WeeklyStudyPlan | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getUserWeeklyStudyPlans(userId: number): Promise<WeeklyStudyPlan[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getActiveWeeklyPlan(userId: number): Promise<WeeklyStudyPlan | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createWeeklyStudyPlan(plan: InsertWeeklyStudyPlan): Promise<WeeklyStudyPlan>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateWeeklyStudyPlan(id: number, data: Partial<WeeklyStudyPlan>): Promise<WeeklyStudyPlan | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  completeWeeklyPlan(id: number): Promise<WeeklyStudyPlan | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  generateWeeklyAiRecommendations(userId: number, planId: number): Promise<string>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // AI Logging operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createAiConceptLog(log: InsertAiConceptLog): Promise<AiConceptLog>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getAiConceptLogs(userId: number, limit?: number): Promise<AiConceptLog[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateAiConceptLog(id: number, data: Partial<AiConceptLog>): Promise<AiConceptLog | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createAiStudyTipsLog(log: InsertAiStudyTipsLog): Promise<AiStudyTipsLog>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getAiStudyTipsLogs(userId: number, limit?: number): Promise<AiStudyTipsLog[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateAiStudyTipsLog(id: number, data: Partial<AiStudyTipsLog>): Promise<AiStudyTipsLog | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  createAiReviewLog(log: InsertAiReviewLog): Promise<AiReviewLog>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  getAiReviewLogs(userId: number, limit?: number): Promise<AiReviewLog[]>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  updateAiReviewLog(id: number, data: Partial<AiReviewLog>): Promise<AiReviewLog | undefined>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Session store

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  sessionStore: SessionStore;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
}

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
// Database storage implementation

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
export class DatabaseStorage implements IStorage {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  sessionStore: SessionStore;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  constructor() {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    this.sessionStore = new PostgresSessionStore({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      pool,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      createTableIfMissing: true,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Check if we need to seed the database

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    this.seedDatabaseIfEmpty();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  private async seedDatabaseIfEmpty() {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    try {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Check if we have any courses

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const existingCourses = await this.getCourses();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (existingCourses.length === 0) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        console.log("Seeding database with initial data...");

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        await this.seedSampleData();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } catch (error) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.error("Error checking or seeding database:", error);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  private async seedSampleData() {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    try {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // First check if we have an instructor

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      let instructorId = 1; // Default to the first user

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const instructorUser = await this.getUserByUsername("instructor");

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (!instructorUser) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        // Create a sample instructor user

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        const instructor = await this.createUser({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          username: "instructor",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          password: "$2b$10$D8OXXrBpHCqB/JikS6UT5Or2w9K1q4kBTfTa9L4cFbz/5lxDxjOe.", // instructor123

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          displayName: "John Instructor",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          role: "instructor"

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        instructorId = instructor.id;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      } else {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        instructorId = instructorUser.id;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Create sample courses

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const course1 = await this.createCourse({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        title: "Introduction to JavaScript",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        description: "Learn the basics of JavaScript programming language",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        category: "Programming",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        moduleCount: 8,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        durationHours: 24,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        instructorId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        imageUrl: "https://images.unsplash.com/photo-1517694712202-14dd9538aa97?ixlib=rb-1.2.1&auto=format&fit=crop&w=300&q=80",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        rating: 4

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const course2 = await this.createCourse({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        title: "Data Science Fundamentals",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        description: "Introduction to data science concepts and tools",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        category: "Data Science",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        moduleCount: 10,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        durationHours: 30,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        instructorId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        imageUrl: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-1.2.1&auto=format&fit=crop&w=300&q=80",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        rating: 5

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const course3 = await this.createCourse({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        title: "Web Development Bootcamp",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        description: "Comprehensive course on full-stack web development",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        category: "Web Development",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        moduleCount: 12,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        durationHours: 40,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        instructorId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        imageUrl: "https://images.unsplash.com/photo-1547658719-da2b51169166?ixlib=rb-1.2.1&auto=format&fit=crop&w=300&q=80",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        rating: 5

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Create sample assignments

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      await this.createAssignment({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        title: "JavaScript Basics Quiz",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        description: "Test your knowledge of JavaScript fundamentals",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        courseId: course1.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // One week from now

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      await this.createAssignment({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        title: "Data Analysis Project",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        description: "Analyze a real-world dataset and present your findings",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        courseId: course2.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000) // Two weeks from now

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      await this.createAssignment({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        title: "Portfolio Website",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        description: "Build a personal portfolio website using HTML, CSS, and JavaScript",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        courseId: course3.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        dueDate: new Date(Date.now() + 21 * 24 * 60 * 60 * 1000) // Three weeks from now

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Create sample badges

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const badge1 = await this.createBadge({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        title: "JavaScript Master",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        description: "Completed the JavaScript course with excellence",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        imageUrl: "https://img.icons8.com/color/96/000000/javascript.png"

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const badge2 = await this.createBadge({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        title: "Data Scientist",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        description: "Successfully completed the data science course",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        imageUrl: "https://img.icons8.com/color/96/000000/python.png"

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const badge3 = await this.createBadge({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        title: "Web Developer",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        description: "Mastered full-stack web development",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        imageUrl: "https://img.icons8.com/color/96/000000/html-5.png"

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.log("Database seeded successfully!");

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } catch (error) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.error("Error seeding database:", error);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUser(id: number): Promise<User | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [user] = await db.select().from(users).where(eq(users.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return user;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserById(id: number): Promise<User | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [user] = await db.select().from(users).where(eq(users.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return user;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserByUsername(username: string): Promise<User | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    try {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [user] = await db.select().from(users).where(eq(users.username, username));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return user;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } catch (error: any) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.log('getUserByUsername error:', error?.message);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return undefined;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createUser(insertUser: InsertUser): Promise<User> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [user] = await db.insert(users).values(insertUser).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return user;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUser(id: number, data: Partial<User>): Promise<User | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedUser] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(users)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(users.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedUser;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Course operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCourses(): Promise<Course[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db.select().from(courses).orderBy(courses.title);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCourse(id: number): Promise<Course | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [course] = await db.select().from(courses).where(eq(courses.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return course;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createCourse(course: InsertCourse): Promise<Course> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newCourse] = await db.insert(courses).values(course).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newCourse;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateCourse(id: number, data: Partial<Course>): Promise<Course | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedCourse] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(courses)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(courses.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedCourse;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // UserCourse operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserCourses(userId: number): Promise<(UserCourse & { course: Course })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const userCoursesResult = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userCourse: userCourses,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        course: courses

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userCourses)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(courses, eq(userCourses.courseId, courses.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userCourses.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(userCourses.enrolledAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return userCoursesResult.map(({ userCourse, course }) => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...userCourse,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      course: course as Course // Type cast to handle potential null

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })) as (UserCourse & { course: Course })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async enrollUserInCourse(userCourse: InsertUserCourse): Promise<UserCourse> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newUserCourse] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userCourses)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(userCourse)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newUserCourse;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserCourseProgress(id: number, progress: number): Promise<UserCourse | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const completed = progress >= 100;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedUserCourse] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userCourses)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        progress, 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        completed 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userCourses.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedUserCourse;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Assignment operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAssignments(): Promise<Assignment[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db.select().from(assignments).orderBy(desc(assignments.dueDate));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserAssignments(userId: number): Promise<(Assignment & { course: Course })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    try {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Get courses the user is enrolled in

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const userCoursesResult = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select({ courseId: userCourses.courseId })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(userCourses)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(userCourses.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const courseIds = userCoursesResult.map(row => row.courseId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (courseIds.length === 0) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        return [];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Get assignments for these courses with course details

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const assignmentsResult = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          assignment: assignments,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          course: courses

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(assignments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .leftJoin(courses, eq(assignments.courseId, courses.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(inArray(assignments.courseId, courseIds));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return assignmentsResult.map(({ assignment, course }) => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ...assignment,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        course: course as Course

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })) as (Assignment & { course: Course })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } catch (error: any) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.warn('Error fetching user assignments:', error?.message);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return [];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createAssignment(assignment: InsertAssignment): Promise<Assignment> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newAssignment] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(assignments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(assignment)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newAssignment;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createUserAssignment(userAssignment: InsertUserAssignment): Promise<UserAssignment> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newUserAssignment] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userAssignments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(userAssignment)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newUserAssignment;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Badge operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getBadges(): Promise<Badge[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db.select().from(badges);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createBadge(badge: InsertBadge): Promise<Badge> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newBadge] = await db.insert(badges).values(badge).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newBadge;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserBadges(userId: number): Promise<(UserBadge & { badge: Badge })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const userBadgesResult = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userBadge: userBadges,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        badge: badges

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userBadges)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(badges, eq(userBadges.badgeId, badges.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userBadges.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(userBadges.earnedAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return userBadgesResult.map(({ userBadge, badge }) => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...userBadge,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      badge: badge as Badge // Type cast to handle potential null

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })) as (UserBadge & { badge: Badge })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async awardBadgeToUser(userBadge: InsertUserBadge): Promise<UserBadge> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newUserBadge] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userBadges)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(userBadge)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newUserBadge;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Interest operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserInterests(userId: number, interests: string[]): Promise<User | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedUser] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(users)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ interests })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(users.id, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedUser;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // AI Generated Courses  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAiGeneratedCourses(): Promise<Course[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(courses)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(courses.isAiGenerated, true))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(courses.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Course category operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCategories(): Promise<CourseCategory[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db.select().from(courseCategories).where(eq(courseCategories.isActive, true)).orderBy(courseCategories.order);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCategory(id: number): Promise<CourseCategory | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [category] = await db.select().from(courseCategories).where(eq(courseCategories.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return category;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createCategory(category: InsertCourseCategory): Promise<CourseCategory> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newCategory] = await db.insert(courseCategories).values(category).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newCategory;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateCategory(id: number, data: Partial<CourseCategory>): Promise<CourseCategory | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db.update(courseCategories)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ ...data, updatedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(courseCategories.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deleteCategory(id: number): Promise<boolean> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Soft delete - just mark as inactive

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db.update(courseCategories)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ isActive: false, updatedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(courseCategories.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.rowCount ? result.rowCount > 0 : false;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCategoryTree(): Promise<CourseCategory[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get all active categories ordered by depth and order

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db.select().from(courseCategories)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(courseCategories.isActive, true))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(courseCategories.depth, courseCategories.order);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCoursesInCategory(categoryId: number): Promise<Course[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db.select().from(courses).where(eq(courses.categoryId, categoryId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Module operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getModules(courseId: number): Promise<Module[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    try {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const result = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(modules)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(modules.courseId, courseId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .orderBy(asc(modules.id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return result;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } catch (error) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.error("Database error in getModules:", error);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return [];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createModule(module: InsertModule): Promise<Module> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newModule] = await db.insert(modules).values(module).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newModule;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Lesson operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getLessons(moduleId: number): Promise<Lesson[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(lessons)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(lessons.moduleId, moduleId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(asc(lessons.id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createLesson(lesson: InsertLesson): Promise<Lesson> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newLesson] = await db.insert(lessons).values(lesson).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newLesson;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // UserLesson operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserLessons(userId: number): Promise<(UserLesson & { lesson: Lesson })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    try {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const userLessonsResult = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          userLesson: userLessons,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          lesson: lessons

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(userLessons)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .leftJoin(lessons, eq(userLessons.lessonId, lessons.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(userLessons.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .orderBy(desc(userLessons.lastAccessedAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return userLessonsResult.map(({ userLesson, lesson }) => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ...userLesson,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        lesson: lesson as Lesson

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })) as (UserLesson & { lesson: Lesson })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } catch (error) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.error('Error fetching user lessons:', error);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return [];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserLessonProgress(userId: number, lessonId: number, progress: number): Promise<UserLesson> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Check if a record already exists

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const existingRecord = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userLessons)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          eq(userLessons.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          eq(userLessons.lessonId, lessonId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        )

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      );

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const completed = progress >= 100;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const now = new Date();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (existingRecord.length > 0) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Update existing record

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [updatedRecord] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .update(userLessons)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          progress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          completed,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          lastAccessedAt: now

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            eq(userLessons.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            eq(userLessons.lessonId, lessonId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          )

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        )

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return updatedRecord;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } else {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Create new record

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [newRecord] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .insert(userLessons)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          lessonId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          progress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          completed,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          lastAccessedAt: now

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return newRecord;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Course Recommendation operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCourseRecommendations(userId: number): Promise<CourseRecommendation | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    try {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const recommendations = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(courseRecommendations)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(courseRecommendations.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return recommendations[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } catch (error: any) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.warn('Error fetching course recommendations:', error?.message);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return undefined;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async saveCourseRecommendations(userId: number, recommendations: any): Promise<CourseRecommendation> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    try {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Ensure recommendations is never null

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      let recsToSave = recommendations;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (!recsToSave || (typeof recsToSave === 'string' && recsToSave === 'null')) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        recsToSave = [{ courseId: 1, title: "Web Development Fundamentals", confidence: 0.85 }];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (!Array.isArray(recsToSave)) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        recsToSave = [recsToSave];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [newRecommendation] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .insert(courseRecommendations)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          recommendations: recsToSave,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return newRecommendation;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } catch (error: any) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.warn('Error saving course recommendations:', error?.message);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      throw error;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Learning Path operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getLearningPaths(userId: number): Promise<LearningPath[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(learningPaths)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(learningPaths.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(learningPaths.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserLearningPaths(userId: number): Promise<LearningPath[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(learningPaths)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(learningPaths.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(learningPaths.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getLearningPath(id: number): Promise<(LearningPath & { steps: (LearningPathStep & { course: Course })[] }) | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get learning path

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [learningPath] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(learningPaths)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(learningPaths.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!learningPath) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return undefined;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get steps with course details

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const stepsResult = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        step: learningPathSteps,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        course: courses

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(learningPathSteps)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(courses, eq(learningPathSteps.courseId, courses.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(learningPathSteps.pathId, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(learningPathSteps.order);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const steps = stepsResult.map(({ step, course }) => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...step,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      course: course as Course

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })) as (LearningPathStep & { course: Course })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...learningPath,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      steps

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createLearningPath(path: InsertLearningPath): Promise<LearningPath> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newPath] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(learningPaths)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(path)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newPath;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async addLearningPathStep(step: InsertLearningPathStep): Promise<LearningPathStep> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newStep] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(learningPathSteps)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(step)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newStep;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateLearningPathProgress(id: number, progress: number): Promise<LearningPath | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedPath] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(learningPaths)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        progress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        updatedAt: new Date()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(learningPaths.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedPath;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateLearningPath(id: number, data: Partial<LearningPath>): Promise<LearningPath | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedPath] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(learningPaths)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ...data,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        updatedAt: new Date()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(learningPaths.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedPath;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deleteLearningPath(id: number): Promise<boolean> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    await db.delete(learningPaths).where(eq(learningPaths.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return true;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async markStepAsCompleted(id: number): Promise<LearningPathStep | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [completedStep] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(learningPathSteps)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        completed: true

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(learningPathSteps.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (completedStep) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Update path progress

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const pathId = completedStep.pathId;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Get all steps for the path

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const allSteps = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(learningPathSteps)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(learningPathSteps.pathId, pathId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const completedSteps = allSteps.filter(step => step.completed).length;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const totalSteps = allSteps.length;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Calculate progress percentage

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const progress = Math.round((completedSteps / totalSteps) * 100);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Update learning path progress

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      await this.updateLearningPathProgress(pathId, progress);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return completedStep;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async generateLearningPath(userId: number, goal: string): Promise<LearningPath> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // This is a stub for now - the actual implementation will be in the AI service

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const newPath = await this.createLearningPath({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      title: `Learning Path for: ${goal}`,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      description: `A custom learning path to achieve your goal: ${goal}`,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      goal,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      progress: 0

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newPath;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async generateAndSyncCurriculum(userId: number, courseId: number): Promise<any> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Stub implementation for curriculum generation

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return { success: true, message: "Curriculum synced" };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Analytics operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async logUserActivity(activity: InsertUserActivityLog): Promise<UserActivityLog> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newLog] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userActivityLogs)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(activity)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newLog;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserActivities(userId: number, limit = 20): Promise<UserActivityLog[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userActivityLogs)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userActivityLogs.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(userActivityLogs.createdAt))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(limit);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserActivityByTimeframe(userId: number, startDate: Date, endDate: Date): Promise<UserActivityLog[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userActivityLogs)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          eq(userActivityLogs.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          sql`${userActivityLogs.createdAt} >= ${startDate}`,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          sql`${userActivityLogs.createdAt} <= ${endDate}`

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        )

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      )

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(userActivityLogs.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Course Analytics operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCourseAnalytics(courseId: number): Promise<CourseAnalytic | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [analytic] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(courseAnalytics)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(courseAnalytics.courseId, courseId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return analytic;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateCourseAnalytics(courseId: number, data: Partial<InsertCourseAnalytic>): Promise<CourseAnalytic> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const existing = await this.getCourseAnalytics(courseId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (existing) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Update existing analytics

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .update(courseAnalytics)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(courseAnalytics.id, existing.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } else {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Create new analytics

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [created] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .insert(courseAnalytics)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          courseId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          totalEnrollments: data.totalEnrollments || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          completionRate: data.completionRate || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          averageRating: data.averageRating,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          averageCompletionTime: data.averageCompletionTime,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          dropoffRate: data.dropoffRate || 0

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return created;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getPopularCourses(limit = 10): Promise<(CourseAnalytic & { course: Course })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const popularCoursesResult = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        analytics: courseAnalytics,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        course: courses

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(courseAnalytics)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(courses, eq(courseAnalytics.courseId, courses.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(courseAnalytics.totalEnrollments))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(limit);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return popularCoursesResult.map(({ analytics, course }) => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...analytics,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      course: course as Course

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })) as (CourseAnalytic & { course: Course })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Progress Snapshot operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserProgressSnapshot(userId: number, date?: Date): Promise<UserProgressSnapshot | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const conditions = [eq(userProgressSnapshots.userId, userId)];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (date) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      conditions.push(sql`DATE(${userProgressSnapshots.snapshotDate}) = DATE(${date.toISOString()})`);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [snapshot] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userProgressSnapshots)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(...conditions))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(userProgressSnapshots.snapshotDate))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return snapshot;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createUserProgressSnapshot(data: InsertUserProgressSnapshot): Promise<UserProgressSnapshot> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [snapshot] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userProgressSnapshots)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return snapshot;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserProgressOverTime(userId: number, startDate: Date, endDate: Date): Promise<UserProgressSnapshot[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userProgressSnapshots)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          eq(userProgressSnapshots.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          sql`${userProgressSnapshots.snapshotDate} >= ${startDate}`,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          sql`${userProgressSnapshots.snapshotDate} <= ${endDate}`

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        )

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      )

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(asc(userProgressSnapshots.snapshotDate));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getPlatformStats(): Promise<{

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    totalUsers: number,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    totalCourses: number,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    totalLessonsCompleted: number,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    totalAssignmentsCompleted: number,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    averageGrade: number

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    try {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Count total users

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [userCount] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select({ count: sql`count(*)` })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(users);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Count total courses

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [courseCount] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select({ count: sql`count(*)` })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(courses);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Count completed lessons

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [lessonCount] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select({ count: sql`count(*)` })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(userLessons)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(userLessons.completed, true));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Count completed assignments

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [assignmentCount] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select({ count: sql`count(*)` })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(userAssignments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(userAssignments.status, 'submitted'));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Calculate average grade from assignments

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [averageGradeResult] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select({ average: sql`avg(${userAssignments.grade})` })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(userAssignments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(userAssignments.status, 'graded'));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        totalUsers: Number(userCount.count) || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        totalCourses: Number(courseCount.count) || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        totalLessonsCompleted: Number(lessonCount.count) || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        totalAssignmentsCompleted: Number(assignmentCount.count) || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        averageGrade: Number(averageGradeResult.average) || 0

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } catch (error) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.error("Error getting platform stats:", error);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      throw error;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Challenge operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getChallenges(filters?: { type?: string; active?: boolean; category?: string }): Promise<Challenge[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db.select().from(challenges);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (filters) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (filters.type) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        query = query.where(eq(challenges.type, filters.type));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (filters.category) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        query = query.where(eq(challenges.category, filters.category));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (filters.active !== undefined) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        query = query.where(eq(challenges.isActive, filters.active));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return query.orderBy(challenges.title);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getChallenge(id: number): Promise<Challenge | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [challenge] = await db.select().from(challenges).where(eq(challenges.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return challenge;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createChallenge(challenge: InsertChallenge): Promise<Challenge> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newChallenge] = await db.insert(challenges).values(challenge).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newChallenge;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateChallenge(id: number, data: Partial<Challenge>): Promise<Challenge | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedChallenge] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(challenges)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(challenges.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedChallenge;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deactivateChallenge(id: number): Promise<Challenge | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [deactivatedChallenge] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(challenges)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ isActive: false })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(challenges.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return deactivatedChallenge;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCourseRelatedChallenges(courseId: number): Promise<Challenge[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(challenges)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(challenges.courseId, courseId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(challenges.isActive, true)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User challenge operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserChallenges(userId: number): Promise<(UserChallenge & { challenge: Challenge })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const userChallengesResult = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userChallenge: userChallenges,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        challenge: challenges

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userChallenges)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(challenges, eq(userChallenges.challengeId, challenges.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userChallenges.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(userChallenges.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return userChallengesResult.map(({ userChallenge, challenge }) => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...userChallenge,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      challenge: challenge as Challenge

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })) as (UserChallenge & { challenge: Challenge })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserActiveAndCompletedChallenges(userId: number): Promise<{

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    active: (UserChallenge & { challenge: Challenge })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    completed: (UserChallenge & { challenge: Challenge })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const userChallenges = await this.getUserChallenges(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const active = userChallenges.filter(uc => !uc.isCompleted);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const completed = userChallenges.filter(uc => uc.isCompleted);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return { active, completed };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async assignChallengeToUser(userId: number, challengeId: number): Promise<UserChallenge> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Check if this challenge has already been assigned to the user

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const existing = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userChallenges)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userChallenges.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userChallenges.challengeId, challengeId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (existing.length > 0) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return existing[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Assign new challenge

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newUserChallenge] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userChallenges)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        challengeId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        progress: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        isCompleted: false,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        pointsEarned: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        xpEarned: 0

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newUserChallenge;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserChallengeProgress(userId: number, challengeId: number, progress: number): Promise<UserChallenge | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Handle out-of-range progress values

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const sanitizedProgress = Math.max(0, Math.min(100, progress));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedUserChallenge] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userChallenges)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        progress: sanitizedProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        // Mark as completed if progress reaches 100%

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ...(sanitizedProgress >= 100 ? { isCompleted: true } : {})

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userChallenges.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userChallenges.challengeId, challengeId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedUserChallenge;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async completeUserChallenge(userId: number, challengeId: number): Promise<UserChallenge | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get the challenge to determine rewards

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const challenge = await this.getChallenge(challengeId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!challenge) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return undefined;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Update the user challenge

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [completedUserChallenge] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userChallenges)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        isCompleted: true,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        progress: 100,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        completedAt: new Date(),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        pointsEarned: challenge.pointsReward,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        xpEarned: challenge.xpReward

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userChallenges.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userChallenges.challengeId, challengeId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (completedUserChallenge) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Add XP and points to user level

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      await this.addUserXp(userId, challenge.xpReward);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      await this.addUserPoints(userId, challenge.pointsReward);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Award badge if applicable

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (challenge.badgeId) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        await this.awardBadgeToUser({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          badgeId: challenge.badgeId

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return completedUserChallenge;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User level operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserLevel(userId: number): Promise<UserLevel | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [level] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userLevels)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userLevels.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return level;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async initializeUserLevel(userId: number): Promise<UserLevel> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Check if user level already exists

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const existingLevel = await this.getUserLevel(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (existingLevel) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return existingLevel;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Create new user level

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newUserLevel] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userLevels)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        level: 1,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        currentXp: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        totalXp: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        nextLevelXp: 100,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        streak: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        totalPoints: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        lastActivityDate: new Date().toISOString()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newUserLevel;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async addUserXp(userId: number, xpAmount: number): Promise<UserLevel | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Ensure user level exists

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let userLevel = await this.getUserLevel(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!userLevel) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      userLevel = await this.initializeUserLevel(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const newCurrentXp = userLevel.currentXp + xpAmount;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const newTotalXp = userLevel.totalXp + xpAmount;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Check if user should level up

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let { level, nextLevelXp } = userLevel;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let remainingXp = newCurrentXp;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    while (remainingXp >= nextLevelXp) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Level up

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      level += 1;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      remainingXp -= nextLevelXp;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Increase XP required for next level (formula: nextLevelXp = currentLevel * 100)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      nextLevelXp = level * 100;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Update user level

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedUserLevel] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userLevels)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        level,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        currentXp: remainingXp,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        totalXp: newTotalXp,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        nextLevelXp,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        lastActivityDate: new Date().toISOString()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userLevels.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedUserLevel;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async addUserPoints(userId: number, pointsAmount: number): Promise<UserLevel | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Ensure user level exists

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let userLevel = await this.getUserLevel(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!userLevel) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      userLevel = await this.initializeUserLevel(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const newTotalPoints = userLevel.totalPoints + pointsAmount;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Update user level

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedUserLevel] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userLevels)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        totalPoints: newTotalPoints,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        lastActivityDate: new Date().toISOString()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userLevels.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedUserLevel;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserStreak(userId: number): Promise<UserLevel | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Ensure user level exists

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let userLevel = await this.getUserLevel(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!userLevel) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      userLevel = await this.initializeUserLevel(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return userLevel;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const today = new Date().toISOString().split('T')[0]; // Format as YYYY-MM-DD

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const lastActivity = userLevel.lastActivityDate ? 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      userLevel.lastActivityDate.toISOString().split('T')[0] : null;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // If already logged activity today, no streak update needed

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (lastActivity === today) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return userLevel;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // If last activity was yesterday, increment streak

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const yesterday = new Date();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    yesterday.setDate(yesterday.getDate() - 1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const yesterdayStr = yesterday.toISOString().split('T')[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let newStreak = userLevel.streak;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (lastActivity === yesterdayStr) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      newStreak += 1;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } else {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Reset streak if more than a day has passed

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      newStreak = 1;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Update streak

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedUserLevel] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userLevels)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        streak: newStreak,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        lastActivityDate: new Date()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userLevels.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedUserLevel;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async resetUserStreak(userId: number): Promise<UserLevel | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedUserLevel] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userLevels)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        streak: 0

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userLevels.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedUserLevel;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async unlockUserAchievement(userId: number, achievementId: number): Promise<UserAchievement> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [userAchievement] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userAchievements)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        achievementId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        pointsEarned: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        xpEarned: 0

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return userAchievement;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserCompletedChallengesCount(userId: number): Promise<number> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({ count: sql<number>`count(*)` })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userChallenges)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userChallenges.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userChallenges.isCompleted, true)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result[0]?.count || 0;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserCompletedCoursesCount(userId: number): Promise<number> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({ count: sql<number>`count(*)` })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userCourses)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userCourses.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userCourses.progress, 100)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result[0]?.count || 0;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Achievement operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAchievements(filters?: { category?: string; rarity?: string; }): Promise<Achievement[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db.select().from(achievements);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (filters) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (filters.category) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        query = query.where(eq(achievements.category, filters.category));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (filters.rarity) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        query = query.where(eq(achievements.rarity, filters.rarity));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return query.orderBy(achievements.title);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAchievement(id: number): Promise<Achievement | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [achievement] = await db.select().from(achievements).where(eq(achievements.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return achievement;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createAchievement(achievement: InsertAchievement): Promise<Achievement> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newAchievement] = await db.insert(achievements).values(achievement).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newAchievement;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserAchievements(userId: number): Promise<(UserAchievement & { achievement: Achievement })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userAchievement: userAchievements,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        achievement: achievements

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userAchievements)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .innerJoin(achievements, eq(userAchievements.achievementId, achievements.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userAchievements.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(userAchievements.earnedAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.map(({ userAchievement, achievement }) => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...userAchievement,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      achievement: achievement as Achievement

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })) as (UserAchievement & { achievement: Achievement })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async awardAchievementToUser(userId: number, achievementId: number): Promise<UserAchievement> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [userAchievement] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userAchievements)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        achievementId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        pointsEarned: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        xpEarned: 0

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return userAchievement;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Leaderboard operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getLeaderboards(filters?: { type?: string; timeframe?: string; }): Promise<Leaderboard[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db.select().from(leaderboards);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (filters) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (filters.type) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        query = query.where(eq(leaderboards.type, filters.type));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (filters.timeframe) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        query = query.where(eq(leaderboards.timeframe, filters.timeframe));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return query.orderBy(leaderboards.title);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getLeaderboard(id: number): Promise<(Leaderboard & { entries: (LeaderboardEntry & { user: User })[] }) | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [leaderboard] = await db.select().from(leaderboards).where(eq(leaderboards.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!leaderboard) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return undefined;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const entries = await this.getLeaderboardEntries(id, 100);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...leaderboard,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      entries

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createLeaderboard(leaderboard: InsertLeaderboard): Promise<Leaderboard> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newLeaderboard] = await db.insert(leaderboards).values(leaderboard).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newLeaderboard;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateLeaderboardEntry(userId: number, leaderboardId: number, score: number): Promise<LeaderboardEntry> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Check if entry exists

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [existingEntry] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(leaderboardEntries)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(leaderboardEntries.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(leaderboardEntries.leaderboardId, leaderboardId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (existingEntry) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Update existing entry only if new score is better

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (score > existingEntry.score) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        const [updatedEntry] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          .update(leaderboardEntries)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          .set({ 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            score,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            updatedAt: new Date()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            eq(leaderboardEntries.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            eq(leaderboardEntries.leaderboardId, leaderboardId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          ))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        return updatedEntry;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return existingEntry;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } else {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Create new entry

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [newEntry] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .insert(leaderboardEntries)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          leaderboardId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          score,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          rank: 0 // Will be calculated

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return newEntry;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getLeaderboardEntries(leaderboardId: number, limit: number = 50): Promise<(LeaderboardEntry & { user: User })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        id: leaderboardEntries.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userId: leaderboardEntries.userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        leaderboardId: leaderboardEntries.leaderboardId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        score: leaderboardEntries.score,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        rank: leaderboardEntries.rank,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        createdAt: leaderboardEntries.createdAt,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        updatedAt: leaderboardEntries.updatedAt,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        user: users

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(leaderboardEntries)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .innerJoin(users, eq(leaderboardEntries.userId, users.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(leaderboardEntries.leaderboardId, leaderboardId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(leaderboardEntries.score))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(limit);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserRankings(userId: number): Promise<(LeaderboardEntry & { leaderboard: Leaderboard })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        id: leaderboardEntries.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userId: leaderboardEntries.userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        leaderboardId: leaderboardEntries.leaderboardId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        score: leaderboardEntries.score,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        rank: leaderboardEntries.rank,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        createdAt: leaderboardEntries.createdAt,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        updatedAt: leaderboardEntries.updatedAt,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        leaderboard: leaderboards

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(leaderboardEntries)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .innerJoin(leaderboards, eq(leaderboardEntries.leaderboardId, leaderboards.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(leaderboardEntries.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(leaderboardEntries.score));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Get all users with their levels for leaderboard calculations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAllUsersWithLevels(): Promise<any[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db.select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      userId: userLevels.userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      level: userLevels.level,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      currentXp: userLevels.currentXp,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      totalXp: userLevels.totalXp,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      streak: userLevels.streak,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      user: {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        id: users.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        username: users.username,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        displayName: users.displayName,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        avatarUrl: users.avatarUrl

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    .from(userLevels)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    .innerJoin(users, eq(userLevels.userId, users.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    .orderBy(desc(userLevels.totalXp));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Get all achievements for the achievements gallery

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAllAchievements(): Promise<Achievement[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db.select().from(achievements).where(eq(achievements.isActive, true));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Get user activity logs

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserActivityLogs(userId: number, limit: number = 10): Promise<any[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db.select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userActivityLogs)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userActivityLogs.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(userActivityLogs.createdAt))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(limit);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Social media operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getSocialFeed(userId: number, limit: number = 20): Promise<any[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Generate realistic social feed based on user activities

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const activities = await this.getUserActivityLogs(userId, limit);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const achievements = await this.getUserAchievements(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const userLevel = await this.getUserLevel(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const socialPosts = [

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        id: 1,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userId: userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        type: 'achievement',

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        content: `Just unlocked a new achievement! `,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        data: achievements.length > 0 ? achievements[0] : null,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        likes: Math.floor(Math.random() * 20) + 5,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        comments: Math.floor(Math.random() * 10) + 2,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        createdAt: new Date(),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        user: await this.getUser(userId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      },

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        id: 2,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userId: userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        type: 'level_up',

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        content: `Level up! Now at level ${userLevel?.level || 1} `,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        data: { level: userLevel?.level || 1, xp: userLevel?.totalXp || 0 },

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        likes: Math.floor(Math.random() * 15) + 8,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        comments: Math.floor(Math.random() * 8) + 1,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        createdAt: new Date(Date.now() - 1000 * 60 * 60),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        user: await this.getUser(userId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    ];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return socialPosts;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createSocialPost(post: { userId: number; type: string; content: string; data?: any }): Promise<any> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // In a real implementation, this would save to a social_posts table

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const newPost = {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      id: Date.now(),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...post,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      likes: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      comments: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      createdAt: new Date(),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      user: await this.getUser(post.userId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newPost;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async togglePostLike(postId: number, userId: number): Promise<{ liked: boolean; likeCount: number }> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // In a real implementation, this would update a likes table

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const isLiked = Math.random() > 0.5;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const likeCount = Math.floor(Math.random() * 50) + 1;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      liked: isLiked,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      likeCount: isLiked ? likeCount + 1 : likeCount - 1

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserSocialProfile(userId: number): Promise<any> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const user = await this.getUser(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const userLevel = await this.getUserLevel(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const achievements = await this.getUserAchievements(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const courses = await this.getUserCourses(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      user,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      level: userLevel?.level || 1,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      totalXp: userLevel?.totalXp || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      achievementCount: achievements.length,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      courseCount: courses.length,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      followers: Math.floor(Math.random() * 100) + 10,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      following: Math.floor(Math.random() * 150) + 20,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      postsCount: Math.floor(Math.random() * 50) + 5

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async toggleUserFollow(followerId: number, followingId: number, action: string): Promise<{ following: boolean; followerCount: number }> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // In a real implementation, this would update a follows table

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const isFollowing = action === 'follow';

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const followerCount = Math.floor(Math.random() * 500) + 50;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      following: isFollowing,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      followerCount: isFollowing ? followerCount + 1 : followerCount - 1

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTrendingTopics(): Promise<any[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return [

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      { tag: '#WebDevelopment', posts: 1247 },

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      { tag: '#JavaScript', posts: 892 },

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      { tag: '#ReactJS', posts: 654 },

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      { tag: '#TurkishUniversity', posts: 543 },

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      { tag: '#Mathematics', posts: 432 },

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      { tag: '#Programming', posts: 321 }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    ];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async checkAndUnlockAchievements(userId: number): Promise<Achievement[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const allAchievements = await this.getAchievements();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const userAchievements = await this.getUserAchievements(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const userLevel = await this.getUserLevel(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const userChallenges = await this.getUserChallenges(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const userCourses = await this.getUserCourses(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const unlockedAchievementIds = userAchievements.map(ua => ua.achievement.id);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const newlyUnlocked: Achievement[] = [];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    for (const achievement of allAchievements) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (unlockedAchievementIds.includes(achievement.id)) continue;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      let shouldUnlock = false;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Check different achievement criteria

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (achievement.category === 'course_completion') {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        const completedCourses = userCourses.filter(uc => uc.progress >= 100).length;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        shouldUnlock = completedCourses >= 1;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      } else if (achievement.category === 'challenge_completion') {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        const completedChallenges = userChallenges.filter(uc => uc.progress >= 100).length;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        shouldUnlock = completedChallenges >= 1;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      } else if (achievement.category === 'streak') {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        shouldUnlock = (userLevel?.streak || 0) >= 3;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      } else if (achievement.category === 'xp') {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        shouldUnlock = (userLevel?.totalXp || 0) >= 1000;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      } else if (achievement.category === 'level') {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        shouldUnlock = (userLevel?.level || 0) >= 5;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (shouldUnlock) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        await this.awardAchievementToUser(userId, achievement.id);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        newlyUnlocked.push(achievement);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newlyUnlocked;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Interactive Lesson Trails Methods

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserLearningTrails(userId: number) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const trails = await db.select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      id: lessonTrails.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      courseId: lessonTrails.courseId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      title: lessonTrails.title,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      description: lessonTrails.description,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      difficulty: lessonTrails.difficulty,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      estimatedTime: lessonTrails.estimatedTime,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      trailData: lessonTrails.trailData,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      createdAt: lessonTrails.createdAt

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    .from(lessonTrails)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    .leftJoin(userTrailProgress, eq(userTrailProgress.trailId, lessonTrails.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    .where(eq(userTrailProgress.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Add progress data to each trail

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const trailsWithProgress = await Promise.all(trails.map(async (trail) => {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [progress] = await db.select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(userTrailProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          eq(userTrailProgress.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          eq(userTrailProgress.trailId, trail.id)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ...trail,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        progress: progress ? {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          completedNodes: progress.completedNodes || [],

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          currentNode: progress.currentNode,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          totalProgress: progress.progress || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          timeSpent: progress.timeSpent || 0

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        } : null

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return trailsWithProgress;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async acceptPersonalizedRecommendation(recommendationId: number, userId: number) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    await db.update(personalizedRecommendations)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ acceptedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(personalizedRecommendations.id, recommendationId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(personalizedRecommendations.userId, userId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserLearningStats(userId: number) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get user level data

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [userLevel] = await db.select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userLevels)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userLevels.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get completed trails count

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const completedTrails = await db.select({ count: sql`count(*)` })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userTrailProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userTrailProgress.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userTrailProgress.progress, 100)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get total study time

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const totalStudyTime = await db.select({ 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      total: sql`coalesce(sum(${userTrailProgress.timeSpent}), 0)` 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    .from(userTrailProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    .where(eq(userTrailProgress.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get recent learning analytics for performance calculation

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const recentAnalytics = await db.select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(learningAnalytics)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(learningAnalytics.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(learningAnalytics.createdAt))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(20);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const averagePerformance = recentAnalytics.length > 0 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ? recentAnalytics.reduce((sum, a) => sum + (Number(a.performanceScore) || 0.7), 0) / recentAnalytics.length

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      : 0.7;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      level: userLevel?.level || 1,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      totalXp: userLevel?.totalXp || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      streak: userLevel?.streak || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      completedTrails: parseInt(completedTrails[0].count as string) || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      totalStudyTime: parseInt(totalStudyTime[0].total as string) || 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      averagePerformance,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      learningStyle: 'visual', // Could be determined by analyzing user behavior

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      bestSubject: 'Mathematics', // Could be calculated from performance data

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      focusArea: 'Problem Solving' // Could be derived from recent activities

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Learning Milestones methods

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserMilestones(userId: number): Promise<LearningMilestone[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(learningMilestones)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(learningMilestones.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(learningMilestones.timestamp));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createMilestone(data: InsertLearningMilestone): Promise<LearningMilestone> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [milestone] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(learningMilestones)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return milestone;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getMilestone(id: string): Promise<LearningMilestone | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [milestone] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(learningMilestones)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(learningMilestones.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return milestone;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Emoji Reactions methods

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createEmojiReaction(data: InsertEmojiReaction): Promise<EmojiReaction> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [reaction] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(emojiReactions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return reaction;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getMilestoneReactions(milestoneId: string): Promise<EmojiReaction[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(emojiReactions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(emojiReactions.milestoneId, milestoneId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(emojiReactions.timestamp));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserReactions(userId: number): Promise<EmojiReaction[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(emojiReactions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(emojiReactions.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(emojiReactions.timestamp));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Mentor System Operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getMentors(filters?: { isAiMentor?: boolean; isActive?: boolean; specialization?: string }): Promise<(Mentor & { user: User })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        mentor: mentors,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        user: users

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(mentors)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(users, eq(mentors.userId, users.id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (filters?.isAiMentor !== undefined) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(mentors.isAiMentor, filters.isAiMentor));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (filters?.isActive !== undefined) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(mentors.isActive, filters.isActive));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await query.orderBy(desc(mentors.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.map(({ mentor, user }) => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...mentor,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      user: user as User

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })) as (Mentor & { user: User })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getMentor(id: number): Promise<(Mentor & { user: User }) | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [result] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        mentor: mentors,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        user: users

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(mentors)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(users, eq(mentors.userId, users.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(mentors.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!result) return undefined;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...result.mentor,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      user: result.user as User

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } as (Mentor & { user: User });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createMentor(mentor: InsertMentorType): Promise<Mentor> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newMentor] = await db.insert(mentors).values(mentor).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newMentor;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateMentor(id: number, data: Partial<Mentor>): Promise<Mentor | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedMentor] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(mentors)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(mentors.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedMentor;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async assignMentorToUser(studentId: number, mentorId: number, options?: { preferredCommunication?: string; communicationLanguage?: string; notes?: string }): Promise<UserMentor> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // First, deactivate any existing mentor assignments for this student

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userMentors)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ isActive: false })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userMentors.studentId, studentId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newAssignment] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userMentors)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        studentId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        mentorId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        preferredCommunication: options?.preferredCommunication || 'chat',

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        communicationLanguage: options?.communicationLanguage || 'en',

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        notes: options?.notes

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newAssignment;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserMentor(studentId: number): Promise<(UserMentor & { mentor: Mentor & { user: User } }) | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [result] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userMentor: userMentors,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        mentor: mentors,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        user: users

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userMentors)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(mentors, eq(userMentors.mentorId, mentors.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(users, eq(mentors.userId, users.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(eq(userMentors.studentId, studentId), eq(userMentors.isActive, true)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!result) return undefined;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...result.userMentor,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      mentor: {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ...result.mentor,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        user: result.user as User

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } as (UserMentor & { mentor: Mentor & { user: User } });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserMentor(id: number, data: Partial<UserMentor>): Promise<UserMentor | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedUserMentor] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userMentors)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userMentors.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedUserMentor;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async autoAssignMentor(studentId: number): Promise<UserMentor> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // First try to find an available human mentor

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const availableMentors = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({ mentor: mentors })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(mentors)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(mentors.isActive, true),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(mentors.isAiMentor, false)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(mentors.rating, mentors.createdAt);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let mentorToAssign: Mentor | null = null;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Check capacity of human mentors

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    for (const { mentor } of availableMentors) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const currentStudentCount = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select({ count: sql<number>`count(*)` })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(userMentors)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          eq(userMentors.mentorId, mentor.id),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          eq(userMentors.isActive, true)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (currentStudentCount[0]?.count < mentor.maxStudents) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        mentorToAssign = mentor;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        break;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // If no human mentor available, create or find AI mentor

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!mentorToAssign) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      let aiMentor = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(mentors)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(and(eq(mentors.isAiMentor, true), eq(mentors.isActive, true)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (aiMentor.length === 0) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        // Create AI mentor system user if doesn't exist

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        let aiUser = await this.getUserByUsername("ai_mentor");

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        if (!aiUser) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          aiUser = await this.createUser({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            username: "ai_mentor",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            password: "$2b$10$randomhashedpassword",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            displayName: "AI Learning Assistant",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            role: "instructor"

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        // Create AI mentor

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        mentorToAssign = await this.createMentor({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          userId: aiUser.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          isAiMentor: true,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          specialization: ["general", "mathematics", "science", "language"],

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          languages: ["en", "tr"],

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          maxStudents: 10000,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          bio: "AI-powered learning mentor providing 24/7 personalized guidance and support.",

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          rating: 5.0

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      } else {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        mentorToAssign = aiMentor[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await this.assignMentorToUser(studentId, mentorToAssign.id, {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      preferredCommunication: 'chat',

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      communicationLanguage: 'en',

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      notes: mentorToAssign.isAiMentor ? 'Auto-assigned AI mentor' : 'Auto-assigned human mentor'

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study Program Operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getStudyPrograms(filters?: { targetGroup?: string; isActive?: boolean }): Promise<(StudyProgram & { creator: User })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        program: studyPrograms,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        creator: users

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(studyPrograms)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(users, eq(studyPrograms.createdBy, users.id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (filters?.targetGroup) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(studyPrograms.targetGroup, filters.targetGroup));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (filters?.isActive !== undefined) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(studyPrograms.isActive, filters.isActive));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await query.orderBy(desc(studyPrograms.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.map(({ program, creator }) => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...program,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      creator: creator as User

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })) as (StudyProgram & { creator: User })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getStudyProgram(id: number): Promise<(StudyProgram & { creator: User; schedules: ProgramSchedule[] }) | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [programResult] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        program: studyPrograms,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        creator: users

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(studyPrograms)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(users, eq(studyPrograms.createdBy, users.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(studyPrograms.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!programResult) return undefined;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const schedules = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(programSchedules)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(programSchedules.programId, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(programSchedules.week, programSchedules.day, programSchedules.startTime);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...programResult.program,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      creator: programResult.creator as User,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      schedules

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } as (StudyProgram & { creator: User; schedules: ProgramSchedule[] });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createStudyProgram(program: InsertStudyProgramType): Promise<StudyProgram> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newProgram] = await db.insert(studyPrograms).values(program).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newProgram;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateStudyProgram(id: number, data: Partial<StudyProgram>): Promise<StudyProgram | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedProgram] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(studyPrograms)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ ...data, updatedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(studyPrograms.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedProgram;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserStudyPrograms(userId: number): Promise<(UserProgramProgress & { program: StudyProgram })[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        progress: userProgramProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        program: studyPrograms

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userProgramProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(studyPrograms, eq(userProgramProgress.programId, studyPrograms.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userProgramProgress.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(userProgramProgress.startedAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.map(({ progress, program }) => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ...progress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      program: program as StudyProgram

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    })) as (UserProgramProgress & { program: StudyProgram })[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async enrollUserInProgram(userId: number, programId: number): Promise<UserProgramProgress> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const program = await this.getStudyProgram(programId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!program) throw new Error('Program not found');

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const totalHours = program.totalDurationWeeks * program.weeklyHours;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newProgress] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userProgramProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        programId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        totalHours,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        weeklyGoalHours: program.weeklyHours

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newProgress;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserProgramProgress(userId: number, programId: number, data: Partial<UserProgramProgress>): Promise<UserProgramProgress | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedProgress] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userProgramProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ ...data, lastAccessedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userProgramProgress.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userProgramProgress.programId, programId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedProgress;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Program Schedule Operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getProgramSchedules(programId: number, week?: number): Promise<ProgramSchedule[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(programSchedules)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(programSchedules.programId, programId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (week) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(programSchedules.week, week));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await query.orderBy(programSchedules.week, programSchedules.day, programSchedules.startTime);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createProgramSchedule(schedule: InsertProgramScheduleType): Promise<ProgramSchedule> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newSchedule] = await db.insert(programSchedules).values(schedule).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newSchedule;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateProgramSchedule(id: number, data: Partial<ProgramSchedule>): Promise<ProgramSchedule | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedSchedule] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(programSchedules)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(programSchedules.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedSchedule;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study Session Operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getStudySessions(userId: number, filters?: { programId?: number; startDate?: Date; endDate?: Date }): Promise<StudySession[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(studySessions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(studySessions.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (filters?.programId) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(studySessions.programId, filters.programId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await query.orderBy(desc(studySessions.sessionDate));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createStudySession(session: InsertStudySessionType): Promise<StudySession> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newSession] = await db.insert(studySessions).values(session).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newSession;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateStudySession(id: number, data: Partial<StudySession>): Promise<StudySession | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedSession] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(studySessions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(studySessions.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedSession;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Stripe payment methods

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserStripeInfo(userId: number, stripeInfo: { customerId?: string; subscriptionId?: string }): Promise<User | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const updateData: any = {};

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (stripeInfo.customerId) updateData.stripeCustomerId = stripeInfo.customerId;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (stripeInfo.subscriptionId) updateData.stripeSubscriptionId = stripeInfo.subscriptionId;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedUser] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(users)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(updateData)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(users.id, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedUser;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserWeeklyStats(userId: number, programId?: number): Promise<{ plannedHours: number; actualHours: number; adherenceScore: number }> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const oneWeekAgo = new Date();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        totalDuration: sql<number>`SUM(duration_minutes) / 60.0`,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        sessionCount: sql<number>`COUNT(*)`

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(studySessions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(studySessions.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        sql`session_date >= ${oneWeekAgo}`

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (programId) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(studySessions.programId, programId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [result] = await query;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const actualHours = result?.totalDuration || 0;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get planned hours from user program progress

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let plannedHours = 10; // default

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (programId) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const progress = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select({ weeklyGoalHours: userProgramProgress.weeklyGoalHours })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(userProgramProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          eq(userProgramProgress.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          eq(userProgramProgress.programId, programId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      plannedHours = progress[0]?.weeklyGoalHours || 10;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const adherenceScore = plannedHours > 0 ? Math.min(100, (actualHours / plannedHours) * 100) : 0;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      plannedHours,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      actualHours,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      adherenceScore: Math.round(adherenceScore * 100) / 100

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Level Assessment Operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createLevelAssessment(assessment: InsertLevelAssessment): Promise<number> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newAssessment] = await db.insert(levelAssessments).values(assessment).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newAssessment.id;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getLevelAssessment(id: number): Promise<LevelAssessment | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [assessment] = await db.select().from(levelAssessments).where(eq(levelAssessments.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return assessment;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateLevelAssessment(id: number, data: Partial<LevelAssessment>): Promise<LevelAssessment | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedAssessment] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(levelAssessments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(levelAssessments.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedAssessment;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserAssessments(userId: number): Promise<LevelAssessment[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(levelAssessments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(levelAssessments.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(levelAssessments.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Assessment Question Operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createAssessmentQuestion(question: InsertAssessmentQuestion): Promise<AssessmentQuestion> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newQuestion] = await db.insert(assessmentQuestions).values(question).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newQuestion;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAssessmentQuestions(assessmentId: number): Promise<AssessmentQuestion[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(assessmentQuestions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(assessmentQuestions.assessmentId, assessmentId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(assessmentQuestions.questionNumber);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateAssessmentQuestion(id: number, data: Partial<AssessmentQuestion>): Promise<AssessmentQuestion | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updatedQuestion] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(assessmentQuestions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(assessmentQuestions.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updatedQuestion;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Skill Level Operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserSkillLevels(userId: number): Promise<UserSkillLevel[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userSkillLevels)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userSkillLevels.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(userSkillLevels.lastUpdated));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserSkillLevel(userId: number, subject: string, subCategory?: string): Promise<UserSkillLevel | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userSkillLevels)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userSkillLevels.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userSkillLevels.subject, subject)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (subCategory) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(userSkillLevels.subCategory, subCategory));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [skillLevel] = await query;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return skillLevel;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserSkillLevel(userId: number, skillData: InsertUserSkillLevel): Promise<UserSkillLevel> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Check if skill level already exists

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const existing = await this.getUserSkillLevel(userId, skillData.subject, skillData.subCategory);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (existing) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Update existing skill level

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .update(userSkillLevels)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          ...skillData,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          lastUpdated: new Date(),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          assessmentCount: existing.assessmentCount + 1

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(userSkillLevels.id, existing.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } else {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Create new skill level

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [newSkillLevel] = await db.insert(userSkillLevels).values(skillData).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return newSkillLevel;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // TYT Study Planning System implementations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Student Profile operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytStudentProfile(userId: number): Promise<TytStudentProfile | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const profile = await db.select().from(tytStudentProfiles).where(eq(tytStudentProfiles.userId, userId)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return profile[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createTytStudentProfile(profile: InsertTytStudentProfile): Promise<TytStudentProfile> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newProfile] = await db.insert(tytStudentProfiles).values(profile).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newProfile;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateTytStudentProfile(userId: number, data: Partial<TytStudentProfile>): Promise<TytStudentProfile | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(tytStudentProfiles)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ ...data, updatedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(tytStudentProfiles.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Subject and Topic operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytSubjects(): Promise<TytSubject[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db.select().from(tytSubjects).where(eq(tytSubjects.isActive, true)).orderBy(tytSubjects.id);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytSubject(id: number): Promise<TytSubject | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const subject = await db.select().from(tytSubjects).where(eq(tytSubjects.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return subject[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createTytSubject(subject: InsertTytSubject): Promise<TytSubject> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newSubject] = await db.insert(tytSubjects).values(subject).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newSubject;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytTopics(subjectId?: number): Promise<TytTopic[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db.select().from(tytTopics).where(eq(tytTopics.isActive, true));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (subjectId) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(tytTopics.subjectId, subjectId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await query.orderBy(tytTopics.subjectId, tytTopics.order);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytTopic(id: number): Promise<TytTopic | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const topic = await db.select().from(tytTopics).where(eq(tytTopics.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return topic[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createTytTopic(topic: InsertTytTopic): Promise<TytTopic> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newTopic] = await db.insert(tytTopics).values(topic).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newTopic;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Topic Progress operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserTopicProgress(userId: number, topicId?: number): Promise<UserTopicProgress[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db.select().from(userTopicProgress).where(eq(userTopicProgress.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (topicId) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(userTopicProgress.topicId, topicId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await query.orderBy(userTopicProgress.topicId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserTopicProgress(userId: number, topicId: number, data: Partial<UserTopicProgress>): Promise<UserTopicProgress> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const existing = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userTopicProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(eq(userTopicProgress.userId, userId), eq(userTopicProgress.topicId, topicId)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (existing.length > 0) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .update(userTopicProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .set({ ...data, updatedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(userTopicProgress.id, existing[0].id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } else {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const [newProgress] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .insert(userTopicProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .values({ userId, topicId, ...data })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return newProgress;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createUserTopicProgress(progress: InsertUserTopicProgress): Promise<UserTopicProgress> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newProgress] = await db.insert(userTopicProgress).values(progress).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newProgress;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Trial Exam operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytTrialExams(userId: number): Promise<TytTrialExam[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(tytTrialExams)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(tytTrialExams.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(tytTrialExams.examDate));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytTrialExam(id: number): Promise<TytTrialExam | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const exam = await db.select().from(tytTrialExams).where(eq(tytTrialExams.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return exam[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createTytTrialExam(exam: InsertTytTrialExam): Promise<TytTrialExam> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newExam] = await db.insert(tytTrialExams).values(exam).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newExam;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deleteTytTrialExam(id: number): Promise<boolean> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db.delete(tytTrialExams).where(eq(tytTrialExams.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.rowCount ? result.rowCount > 0 : false;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Daily Study Task operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getDailyStudyTasks(userId: number, date?: string): Promise<DailyStudyTask[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    try {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      let query = db.select().from(dailyStudyTasks).where(eq(dailyStudyTasks.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (date) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        query = query.where(eq(dailyStudyTasks.scheduledDate, date));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return await query;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } catch (error: any) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.warn('Error fetching daily study tasks:', error?.message);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return [];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getDailyStudyTask(id: number): Promise<DailyStudyTask | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const task = await db.select().from(dailyStudyTasks).where(eq(dailyStudyTasks.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return task[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createDailyStudyTask(task: InsertDailyStudyTask): Promise<DailyStudyTask> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newTask] = await db.insert(dailyStudyTasks).values(task).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newTask;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateDailyStudyTask(id: number, data: Partial<DailyStudyTask>): Promise<DailyStudyTask | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(dailyStudyTasks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ ...data, updatedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(dailyStudyTasks.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deleteDailyStudyTask(id: number): Promise<boolean> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db.delete(dailyStudyTasks).where(eq(dailyStudyTasks.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.rowCount ? result.rowCount > 0 : false;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async completeDailyStudyTask(id: number, actualDuration?: number): Promise<DailyStudyTask | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const updateData: any = {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      isCompleted: true,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      completedAt: new Date(),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      updatedAt: new Date()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (actualDuration) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      updateData.actualDuration = actualDuration;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(dailyStudyTasks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(updateData)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(dailyStudyTasks.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCurriculumContextForDailyTasks(userId: number, taskIds: number[]): Promise<Map<number, {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    curriculumTaskId: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    curriculumId: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    curriculumTitleEn: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    curriculumTitleTr: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    skillName: string | null;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    taskTitleEn: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    taskTitleTr: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }>> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (taskIds.length === 0) return new Map();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const results = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        dailyTaskId: userCurriculumTasks.dailyTaskId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        curriculumTaskId: userCurriculumTasks.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        curriculumId: userCurriculums.curriculumId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        curriculumTitleEn: courseCurriculums.titleEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        curriculumTitleTr: courseCurriculums.titleTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        skillName: curriculumSkills.name,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        taskTitleEn: userCurriculumTasks.titleEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        taskTitleTr: userCurriculumTasks.titleTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userCurriculumTasks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .innerJoin(userCurriculums, eq(userCurriculumTasks.userCurriculumId, userCurriculums.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .innerJoin(courseCurriculums, eq(userCurriculums.curriculumId, courseCurriculums.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(curriculumSkills, eq(userCurriculumTasks.skillId, curriculumSkills.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          eq(userCurriculums.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          inArray(userCurriculumTasks.dailyTaskId, taskIds)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        )

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      );

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const contextMap = new Map<number, {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      curriculumTaskId: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      curriculumId: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      curriculumTitleEn: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      curriculumTitleTr: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      skillName: string | null;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      taskTitleEn: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      taskTitleTr: string;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }>();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    for (const row of results) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (row.dailyTaskId) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        contextMap.set(row.dailyTaskId, {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          curriculumTaskId: row.curriculumTaskId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          curriculumId: row.curriculumId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          curriculumTitleEn: row.curriculumTitleEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          curriculumTitleTr: row.curriculumTitleTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          skillName: row.skillName,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          taskTitleEn: row.taskTitleEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          taskTitleTr: row.taskTitleTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return contextMap;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study Session operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytStudySessions(userId: number, filters?: { startDate?: Date; endDate?: Date; subjectId?: number }): Promise<TytStudySession[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db.select().from(tytStudySessions).where(eq(tytStudySessions.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (filters?.startDate) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(sql`${tytStudySessions.startTime} >= ${filters.startDate}`);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (filters?.endDate) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(sql`${tytStudySessions.startTime} <= ${filters.endDate}`);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (filters?.subjectId) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(tytStudySessions.subjectId, filters.subjectId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await query.orderBy(desc(tytStudySessions.startTime));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytStudySession(id: number): Promise<TytStudySession | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const session = await db.select().from(tytStudySessions).where(eq(tytStudySessions.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return session[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createTytStudySession(session: InsertTytStudySession): Promise<TytStudySession> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newSession] = await db.insert(tytStudySessions).values(session).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newSession;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateTytStudySession(id: number, data: Partial<TytStudySession>): Promise<TytStudySession | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(tytStudySessions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(tytStudySessions.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async endTytStudySession(id: number): Promise<TytStudySession | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const session = await this.getTytStudySession(id);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!session || session.endTime) return session;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const endTime = new Date();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const startTime = new Date(session.startTime);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const duration = Math.round((endTime.getTime() - startTime.getTime()) / 60000); // minutes

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(tytStudySessions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        endTime: endTime,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        duration: duration

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(tytStudySessions.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study Goal operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytStudyGoals(userId: number, goalType?: string): Promise<TytStudyGoal[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db.select().from(tytStudyGoals).where(eq(tytStudyGoals.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (goalType) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(eq(tytStudyGoals.goalType, goalType));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await query.orderBy(tytStudyGoals.deadline, desc(tytStudyGoals.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytStudyGoal(id: number): Promise<TytStudyGoal | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const goal = await db.select().from(tytStudyGoals).where(eq(tytStudyGoals.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return goal[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createTytStudyGoal(goal: InsertTytStudyGoal): Promise<TytStudyGoal> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newGoal] = await db.insert(tytStudyGoals).values(goal).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newGoal;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateTytStudyGoal(id: number, data: Partial<TytStudyGoal>): Promise<TytStudyGoal | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(tytStudyGoals)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ ...data, updatedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(tytStudyGoals.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deleteTytStudyGoal(id: number): Promise<boolean> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db.delete(tytStudyGoals).where(eq(tytStudyGoals.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.rowCount ? result.rowCount > 0 : false;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study Streak operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytStudyStreaks(userId: number): Promise<TytStudyStreak[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(tytStudyStreaks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(tytStudyStreaks.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(tytStudyStreaks.streakType);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytStudyStreak(userId: number, streakType: string): Promise<TytStudyStreak | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const streak = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(tytStudyStreaks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(eq(tytStudyStreaks.userId, userId), eq(tytStudyStreaks.streakType, streakType)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return streak[0];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createTytStudyStreak(streak: InsertTytStudyStreak): Promise<TytStudyStreak> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newStreak] = await db.insert(tytStudyStreaks).values(streak).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newStreak;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateTytStudyStreak(userId: number, streakType: string, data: Partial<TytStudyStreak>): Promise<TytStudyStreak | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(tytStudyStreaks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(eq(tytStudyStreaks.userId, userId), eq(tytStudyStreaks.streakType, streakType)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Analytics and Summary operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytStudyStats(userId: number, timeframe?: 'daily' | 'weekly' | 'monthly'): Promise<{

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    totalStudyTime: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    completedTasks: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    averageNetScore: number;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    subjectProgress: Array<{ subject: string; progress: number; timeSpent: number }>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    streaks: Array<{ type: string; current: number; longest: number }>;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Calculate date range based on timeframe

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let startDate = new Date();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    switch (timeframe) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      case 'daily':

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        startDate.setHours(0, 0, 0, 0);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        break;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      case 'weekly':

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        startDate.setDate(startDate.getDate() - 7);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        break;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      case 'monthly':

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        startDate.setMonth(startDate.getMonth() - 1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        break;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      default:

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        startDate = new Date(0); // All time

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get study sessions for total study time

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const sessions = await this.getTytStudySessions(userId, { startDate });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const totalStudyTime = sessions.reduce((total, session) => total + (session.duration || 0), 0);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get completed tasks count

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const tasks = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(dailyStudyTasks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(dailyStudyTasks.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(dailyStudyTasks.isCompleted, true),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        sql`${dailyStudyTasks.completedAt} >= ${startDate}`

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const completedTasks = tasks.length;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get trial exams for average net score

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const trials = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(tytTrialExams)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(tytTrialExams.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        sql`${tytTrialExams.examDate} >= ${startDate}`

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const averageNetScore = trials.length > 0 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ? trials.reduce((sum, trial) => sum + parseFloat(trial.netScore.toString()), 0) / trials.length 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      : 0;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get subject progress (simplified)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const subjectProgress = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        subject: tytSubjects.displayName,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        progress: sql<number>`AVG(${userTopicProgress.progressPercent})`,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        timeSpent: sql<number>`SUM(${userTopicProgress.timeSpent})`

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userTopicProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(tytTopics, eq(userTopicProgress.topicId, tytTopics.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .leftJoin(tytSubjects, eq(tytTopics.subjectId, tytSubjects.id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userTopicProgress.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .groupBy(tytSubjects.id, tytSubjects.displayName);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Get streaks

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const streakData = await this.getTytStudyStreaks(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const streaks = streakData.map(streak => ({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      type: streak.streakType,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      current: streak.currentStreak,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      longest: streak.longestStreak

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      totalStudyTime,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      completedTasks,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      averageNetScore,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      subjectProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      streaks

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // ==================== New Time Tracking & Analytics Implementations ====================

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Daily Study Goals operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getDailyStudyGoal(userId: number, date: string): Promise<DailyStudyGoal | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [goal] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(dailyStudyGoals)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(eq(dailyStudyGoals.userId, userId), eq(dailyStudyGoals.date, date)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return goal;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getDailyStudyGoals(userId: number, startDate?: string, endDate?: string): Promise<DailyStudyGoal[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db.select().from(dailyStudyGoals).where(eq(dailyStudyGoals.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (startDate && endDate) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(dailyStudyGoals.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        sql`${dailyStudyGoals.date} >= ${startDate}`,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        sql`${dailyStudyGoals.date} <= ${endDate}`

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } else if (startDate) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(dailyStudyGoals.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        sql`${dailyStudyGoals.date} >= ${startDate}`

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await query.orderBy(desc(dailyStudyGoals.date));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createDailyStudyGoal(goal: InsertDailyStudyGoal): Promise<DailyStudyGoal> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newGoal] = await db.insert(dailyStudyGoals).values(goal).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newGoal;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateDailyStudyGoal(userId: number, date: string, data: Partial<DailyStudyGoal>): Promise<DailyStudyGoal | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(dailyStudyGoals)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ ...data, updatedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(eq(dailyStudyGoals.userId, userId), eq(dailyStudyGoals.date, date)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Study Habits operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getStudyHabits(userId: number, period?: string): Promise<StudyHabit[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db.select().from(studyHabits).where(eq(studyHabits.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (period) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(and(eq(studyHabits.userId, userId), eq(studyHabits.period, period)));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await query.orderBy(desc(studyHabits.startDate));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getStudyHabit(id: number): Promise<StudyHabit | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [habit] = await db.select().from(studyHabits).where(eq(studyHabits.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return habit;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createStudyHabit(habit: InsertStudyHabit): Promise<StudyHabit> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newHabit] = await db.insert(studyHabits).values(habit).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newHabit;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Daily Study Sessions operations (Time Tracking)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getDailyStudySessions(userId: number, date?: string): Promise<DailyStudySession[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db.select().from(dailyStudySessions).where(eq(dailyStudySessions.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (date) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(and(eq(dailyStudySessions.userId, userId), eq(dailyStudySessions.date, date)));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await query.orderBy(desc(dailyStudySessions.date));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getDailyStudySession(userId: number, date: string): Promise<DailyStudySession | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [session] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(dailyStudySessions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(eq(dailyStudySessions.userId, userId), eq(dailyStudySessions.date, date)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return session;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createDailyStudySession(session: InsertDailyStudySession): Promise<DailyStudySession> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newSession] = await db.insert(dailyStudySessions).values(session).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newSession;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // TYT Resources operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytResources(topicId: number): Promise<TytResource[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(tytResources)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(tytResources.topicId, topicId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(asc(tytResources.id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getTytResource(id: number): Promise<TytResource | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [resource] = await db.select().from(tytResources).where(eq(tytResources.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return resource;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createTytResource(resource: InsertTytResource): Promise<TytResource> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newResource] = await db.insert(tytResources).values(resource).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newResource;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateTytResource(id: number, data: Partial<TytResource>): Promise<TytResource | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(tytResources)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(tytResources.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deleteTytResource(id: number): Promise<boolean> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db.delete(tytResources).where(eq(tytResources.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.rowCount ? result.rowCount > 0 : false;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // AI Daily Plans operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAiDailyPlan(userId: number, date: string): Promise<AiDailyPlan | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [plan] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(aiDailyPlans)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(eq(aiDailyPlans.userId, userId), eq(aiDailyPlans.date, date)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return plan;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAiDailyPlans(userId: number, startDate?: string, endDate?: string): Promise<AiDailyPlan[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    let query = db.select().from(aiDailyPlans).where(eq(aiDailyPlans.userId, userId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (startDate && endDate) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(aiDailyPlans.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        sql`${aiDailyPlans.date} >= ${startDate}`,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        sql`${aiDailyPlans.date} <= ${endDate}`

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } else if (startDate) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      query = query.where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(aiDailyPlans.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        sql`${aiDailyPlans.date} >= ${startDate}`

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await query.orderBy(desc(aiDailyPlans.date));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createAiDailyPlan(plan: InsertAiDailyPlan): Promise<AiDailyPlan> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newPlan] = await db.insert(aiDailyPlans).values(plan).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newPlan;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateAiDailyPlanProgress(userId: number, date: string, completionRate: number): Promise<AiDailyPlan | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const completed = completionRate >= 100;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(aiDailyPlans)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ completionRate, completed })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(eq(aiDailyPlans.userId, userId), eq(aiDailyPlans.date, date)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // ==================== Forum System Implementations ====================

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Forum Posts operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getForumPosts(limit: number = 20, offset: number = 0): Promise<ForumPost[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(forumPosts)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(forumPosts.isPinned), desc(forumPosts.createdAt))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(limit)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .offset(offset);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getForumPost(id: number): Promise<ForumPost | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [post] = await db.select().from(forumPosts).where(eq(forumPosts.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return post;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserForumPosts(userId: number): Promise<ForumPost[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(forumPosts)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(forumPosts.authorId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(forumPosts.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createForumPost(post: InsertForumPost): Promise<ForumPost> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newPost] = await db.insert(forumPosts).values(post).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newPost;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateForumPost(id: number, data: Partial<ForumPost>): Promise<ForumPost | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(forumPosts)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(forumPosts.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deleteForumPost(id: number): Promise<boolean> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db.delete(forumPosts).where(eq(forumPosts.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.rowCount ? result.rowCount > 0 : false;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async incrementPostViews(id: number): Promise<void> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(forumPosts)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ viewCount: sql`${forumPosts.viewCount} + 1` })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(forumPosts.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Forum Comments operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getPostComments(postId: number): Promise<ForumComment[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(forumComments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(forumComments.postId, postId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(forumComments.isAnswer), asc(forumComments.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getForumComment(id: number): Promise<ForumComment | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [comment] = await db.select().from(forumComments).where(eq(forumComments.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return comment;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createForumComment(comment: InsertForumComment): Promise<ForumComment> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newComment] = await db.insert(forumComments).values(comment).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newComment;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateForumComment(id: number, data: Partial<ForumComment>): Promise<ForumComment | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(forumComments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(forumComments.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deleteForumComment(id: number): Promise<boolean> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db.delete(forumComments).where(eq(forumComments.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.rowCount ? result.rowCount > 0 : false;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // ==================== Certificate System Implementations ====================

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserCertificates(userId: number): Promise<Certificate[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(certificates)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(certificates.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(certificates.issueDate));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCertificate(id: number): Promise<Certificate | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [cert] = await db.select().from(certificates).where(eq(certificates.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return cert;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCertificateByNumber(certificateNumber: string): Promise<Certificate | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [cert] = await db.select().from(certificates).where(eq(certificates.certificateNumber, certificateNumber)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return cert;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createCertificate(certificate: InsertCertificate): Promise<Certificate> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newCert] = await db.insert(certificates).values(certificate).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newCert;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async verifyCertificate(verificationCode: string): Promise<Certificate | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [cert] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(certificates)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(eq(certificates.verificationCode, verificationCode), eq(certificates.isActive, true)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return cert;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async revokeCertificate(id: number): Promise<Certificate | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Fetch certificate first for idempotent guard

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const cert = await this.getCertificate(id);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!cert) return undefined;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (!cert.isActive) return cert; // Already revoked, return as-is

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Revoke certificate

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(certificates)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ isActive: false, revokedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(certificates.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // ==================== AI Curriculum System Implementations ====================

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Course Curriculum operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCourseCurriculum(courseId: number): Promise<CourseCurriculum | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [curriculum] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(courseCurriculums)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(courseCurriculums.courseId, courseId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return curriculum;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createCourseCurriculum(curriculum: InsertCourseCurriculum): Promise<CourseCurriculum> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newCurriculum] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(courseCurriculums)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(curriculum)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newCurriculum;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateCourseCurriculum(id: number, data: Partial<CourseCurriculum>): Promise<CourseCurriculum | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(courseCurriculums)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(courseCurriculums.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Curriculum Skill operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCurriculumSkills(curriculumId: number): Promise<CurriculumSkill[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(curriculumSkills)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(curriculumSkills.curriculumId, curriculumId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(asc(curriculumSkills.order));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCurriculumSkill(id: number): Promise<CurriculumSkill | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [skill] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(curriculumSkills)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(curriculumSkills.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return skill;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createCurriculumSkill(skill: InsertCurriculumSkill): Promise<CurriculumSkill> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newSkill] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(curriculumSkills)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(skill)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newSkill;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateCurriculumSkill(id: number, data: Partial<CurriculumSkill>): Promise<CurriculumSkill | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(curriculumSkills)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(curriculumSkills.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Curriculum Module operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCurriculumModules(curriculumId: number): Promise<CurriculumModule[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(curriculumModules)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(curriculumModules.curriculumId, curriculumId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(asc(curriculumModules.order));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCurriculumModule(id: number): Promise<CurriculumModule | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [module] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(curriculumModules)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(curriculumModules.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return module;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createCurriculumModule(module: InsertCurriculumModule): Promise<CurriculumModule> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newModule] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(curriculumModules)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(module)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newModule;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateCurriculumModule(id: number, data: Partial<CurriculumModule>): Promise<CurriculumModule | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(curriculumModules)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(curriculumModules.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Curriculum operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserCurriculum(userId: number, courseId: number): Promise<UserCurriculum | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [userCurriculum] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userCurriculums)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userCurriculums.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userCurriculums.courseId, courseId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return userCurriculum;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserCurriculums(userId: number): Promise<UserCurriculum[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userCurriculums)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userCurriculums.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(userCurriculums.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createUserCurriculum(userCurriculum: InsertUserCurriculum): Promise<UserCurriculum> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newUserCurriculum] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userCurriculums)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(userCurriculum)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newUserCurriculum;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserCurriculumProgress(id: number, progress: number): Promise<UserCurriculum | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userCurriculums)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        progress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        lastAccessedAt: new Date()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userCurriculums.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Curriculum Task operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserCurriculumTasks(userCurriculumId: number): Promise<UserCurriculumTask[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userCurriculumTasks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userCurriculumTasks.userCurriculumId, userCurriculumId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(asc(userCurriculumTasks.scheduledDate));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserCurriculumTask(id: number): Promise<UserCurriculumTask | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [task] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userCurriculumTasks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userCurriculumTasks.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return task;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createUserCurriculumTask(task: InsertUserCurriculumTask): Promise<UserCurriculumTask> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newTask] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userCurriculumTasks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(task)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newTask;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserCurriculumTask(id: number, data: Partial<UserCurriculumTask>): Promise<UserCurriculumTask | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userCurriculumTasks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userCurriculumTasks.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deleteUserCurriculumTask(id: number): Promise<boolean> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .delete(userCurriculumTasks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userCurriculumTasks.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return true;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async completeUserCurriculumTask(id: number, score?: number): Promise<UserCurriculumTask | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userCurriculumTasks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        isCompleted: true,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        completedAt: new Date(),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        score: score || null

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userCurriculumTasks.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // User Skill Progress operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserSkillProgress(userCurriculumId: number): Promise<UserSkillProgress[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userSkillProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userSkillProgress.userCurriculumId, userCurriculumId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserSkillProgressBySkill(userCurriculumId: number, skillId: number): Promise<UserSkillProgress | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [progress] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(userSkillProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userSkillProgress.userCurriculumId, userCurriculumId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(userSkillProgress.skillId, skillId)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return progress;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createUserSkillProgress(progress: InsertUserSkillProgress): Promise<UserSkillProgress> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newProgress] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(userSkillProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(progress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newProgress;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateUserSkillProgress(id: number, data: Partial<UserSkillProgress>): Promise<UserSkillProgress | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(userSkillProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ...data,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        lastAttemptAt: new Date()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(userSkillProgress.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Curriculum Checkpoint operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCurriculumCheckpoints(curriculumId: number): Promise<CurriculumCheckpoint[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(curriculumCheckpoints)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(curriculumCheckpoints.curriculumId, curriculumId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(asc(curriculumCheckpoints.order));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getCurriculumCheckpoint(id: number): Promise<CurriculumCheckpoint | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [checkpoint] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(curriculumCheckpoints)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(curriculumCheckpoints.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return checkpoint;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createCurriculumCheckpoint(checkpoint: InsertCurriculumCheckpoint): Promise<CurriculumCheckpoint> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newCheckpoint] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(curriculumCheckpoints)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(checkpoint)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newCheckpoint;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateCurriculumCheckpoint(id: number, data: Partial<CurriculumCheckpoint>): Promise<CurriculumCheckpoint | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(curriculumCheckpoints)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(curriculumCheckpoints.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Skill Assessment operations

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getSkillAssessments(userCurriculumId: number): Promise<SkillAssessment[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(skillAssessments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(skillAssessments.userCurriculumId, userCurriculumId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(skillAssessments.attemptedAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getSkillAssessment(id: number): Promise<SkillAssessment | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [assessment] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(skillAssessments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(skillAssessments.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return assessment;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createSkillAssessment(assessment: InsertSkillAssessment): Promise<SkillAssessment> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newAssessment] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .insert(skillAssessments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .values(assessment)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newAssessment;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateSkillAssessment(id: number, data: Partial<SkillAssessment>): Promise<SkillAssessment | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(skillAssessments)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(skillAssessments.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Curriculum generation and task sync

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async generateAndSyncCurriculum(userId: number, courseId: number): Promise<{

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    curriculum: UserCurriculum;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    tasks: UserCurriculumTask[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    skills: CurriculumSkill[];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    // Check if curriculum already exists for this user and course

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const existingUserCurriculum = await this.getUserCurriculum(userId, courseId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (existingUserCurriculum) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Return existing curriculum with tasks and skills

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const tasks = await this.getUserCurriculumTasks(existingUserCurriculum.id);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const courseCurriculum = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(courseCurriculums)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(courseCurriculums.id, existingUserCurriculum.curriculumId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const skills = courseCurriculum[0] 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ? await this.getCurriculumSkills(courseCurriculum[0].id)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        : [];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        curriculum: existingUserCurriculum,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        tasks,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        skills

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    try {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Import AI service dynamically to avoid circular dependencies

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const { generateCourseCurriculum, generateCurriculumTasks } = await import('./ai-curriculum-service');

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Get course, modules, and lessons (outside transaction)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const course = await this.getCourse(courseId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (!course) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        throw new Error(`Course ${courseId} not found`);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const modules = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(db._.schema.modules)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(eq(db._.schema.modules.courseId, courseId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .orderBy(asc(db._.schema.modules.order));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const lessons = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .from(db._.schema.lessons)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(inArray(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          db._.schema.lessons.moduleId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          modules.map(m => m.id)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        ))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .orderBy(asc(db._.schema.lessons.order));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Get user profile for personalization (outside transaction)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const user = await this.getUser(userId);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      if (!user) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        throw new Error(`User ${userId} not found`);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const userProfile = {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        currentLevel: user.level || 'Beginner',

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        weeklyStudyHours: 10,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        learningPace: 'normal' as const,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        goals: user.interests || [],

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        strengths: [],

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        weaknesses: [],

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        preferredLanguage: (user.language || 'en') as 'en' | 'tr'

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Generate curriculum and tasks using AI (outside transaction)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const generatedCurriculum = await generateCourseCurriculum(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        course,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        modules,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        lessons,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userProfile

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      );

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      const generatedTasks = await generateCurriculumTasks(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        generatedCurriculum,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        userProfile.weeklyStudyHours,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        new Date()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      );

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      // Wrap all database operations in a transaction for atomicity

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return await db.transaction(async (tx) => {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        // Create course curriculum

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        const [courseCurriculum] = await tx

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          .insert(courseCurriculums)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            courseId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            titleEn: generatedCurriculum.titleEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            titleTr: generatedCurriculum.titleTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            descriptionEn: generatedCurriculum.descriptionEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            descriptionTr: generatedCurriculum.descriptionTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            goals: generatedCurriculum.goals,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            prerequisites: generatedCurriculum.prerequisites,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            totalDuration: generatedCurriculum.totalDuration,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            difficultyLevel: generatedCurriculum.difficultyLevel

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        // Create skills

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        const createdSkills: CurriculumSkill[] = [];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        for (const skill of generatedCurriculum.skills) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          const [createdSkill] = await tx

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .insert(curriculumSkills)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              curriculumId: courseCurriculum.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              titleEn: skill.titleEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              titleTr: skill.titleTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              descriptionEn: skill.descriptionEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              descriptionTr: skill.descriptionTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              category: skill.category,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              estimatedHours: skill.estimatedHours,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              order: skill.order,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              prerequisites: skill.prerequisites,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              assessmentCriteria: skill.assessmentCriteria

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          createdSkills.push(createdSkill);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        // Create curriculum modules

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        for (const module of generatedCurriculum.modules) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          await tx

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .insert(curriculumModules)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              curriculumId: courseCurriculum.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              skillId: module.skillIndex !== undefined ? createdSkills[module.skillIndex]?.id || null : null,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              titleEn: module.titleEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              titleTr: module.titleTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              descriptionEn: module.descriptionEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              descriptionTr: module.descriptionTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              order: module.order,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              estimatedDuration: module.estimatedDuration,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              learningObjectives: module.learningObjectives,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              resources: module.resources

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        // Create checkpoints

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        for (const checkpoint of generatedCurriculum.checkpoints) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          await tx

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .insert(curriculumCheckpoints)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              curriculumId: courseCurriculum.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              titleEn: checkpoint.titleEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              titleTr: checkpoint.titleTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              descriptionEn: checkpoint.descriptionEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              descriptionTr: checkpoint.descriptionTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              checkpointType: checkpoint.checkpointType,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              order: checkpoint.order,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              requiredProgress: checkpoint.requiredProgress,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              requiredSkills: checkpoint.requiredSkills,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              passingScore: checkpoint.passingScore,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              estimatedDuration: checkpoint.estimatedDuration

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        // Create user curriculum

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        const [userCurriculum] = await tx

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          .insert(userCurriculums)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            userId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            curriculumId: courseCurriculum.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            courseId,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            progress: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            startedAt: new Date(),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            lastAccessedAt: new Date()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        // Initialize skill progress for all skills

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        for (const skill of createdSkills) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          await tx

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .insert(userSkillProgress)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              userCurriculumId: userCurriculum.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              skillId: skill.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              progress: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              masteryLevel: 'beginner',

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              attempts: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              averageScore: 0,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              lastAttemptAt: null

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        // Create tasks in database

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        const createdTasks: UserCurriculumTask[] = [];

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        for (const task of generatedTasks) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          const [createdTask] = await tx

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .insert(userCurriculumTasks)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .values({

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              userCurriculumId: userCurriculum.id,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              skillId: task.skillIndices && task.skillIndices.length > 0 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
                ? createdSkills[task.skillIndices[0]]?.id || null 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
                : null,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              moduleId: null,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              titleEn: task.titleEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              titleTr: task.titleTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              descriptionEn: task.descriptionEn,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              descriptionTr: task.descriptionTr,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              taskType: task.taskType,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              scheduledDate: task.scheduledDate,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              estimatedDuration: task.estimatedDuration,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              isCompleted: false,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              completedAt: null,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
              score: null

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
            .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          createdTasks.push(createdTask);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        return {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          curriculum: userCurriculum,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          tasks: createdTasks,

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
          skills: createdSkills

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        };

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      });

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    } catch (error) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      console.error('Error generating and syncing curriculum:', error);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      throw new Error(`Failed to generate curriculum: ${error instanceof Error ? error.message : 'Unknown error'}`);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUpload(id: number): Promise<Upload | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [upload] = await db.select().from(uploads).where(eq(uploads.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return upload;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserUploads(userId: number, uploadType?: string): Promise<Upload[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (uploadType) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return await db.select().from(uploads)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(and(eq(uploads.userId, userId), eq(uploads.uploadType, uploadType)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .orderBy(desc(uploads.uploadedAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db.select().from(uploads)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(uploads.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(uploads.uploadedAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createUpload(upload: InsertUpload): Promise<Upload> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [created] = await db.insert(uploads).values(upload).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return created;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deleteUpload(id: number): Promise<boolean> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db.delete(uploads).where(eq(uploads.id, id));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.rowCount ? result.rowCount > 0 : false;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getEssay(id: number): Promise<Essay | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [essay] = await db.select().from(essays).where(eq(essays.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return essay;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserEssays(userId: number, courseId?: number): Promise<Essay[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    if (courseId) {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      return await db.select().from(essays)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .where(and(eq(essays.userId, userId), eq(essays.courseId, courseId)))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        .orderBy(desc(essays.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db.select().from(essays)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(essays.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(essays.createdAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createEssay(essay: InsertEssay): Promise<Essay> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [created] = await db.insert(essays).values(essay).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return created;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateEssay(id: number, data: Partial<Essay>): Promise<Essay | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db.update(essays)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ ...data, updatedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(essays.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async submitEssay(id: number): Promise<Essay | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db.update(essays)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        status: 'submitted', 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        submittedAt: new Date(),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        updatedAt: new Date()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(essays.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async generateAiFeedback(essayId: number, content: string): Promise<string> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return "AI feedback feature requires OpenAI API key configuration. Placeholder feedback returned.";

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getWeeklyStudyPlan(id: number): Promise<WeeklyStudyPlan | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [plan] = await db.select().from(weeklyStudyPlans).where(eq(weeklyStudyPlans.id, id)).limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return plan;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserWeeklyStudyPlans(userId: number): Promise<WeeklyStudyPlan[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db.select().from(weeklyStudyPlans)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(weeklyStudyPlans.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(weeklyStudyPlans.weekStartDate));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getActiveWeeklyPlan(userId: number): Promise<WeeklyStudyPlan | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [plan] = await db.select().from(weeklyStudyPlans)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(and(

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(weeklyStudyPlans.userId, userId),

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        eq(weeklyStudyPlans.status, 'active')

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      ))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(weeklyStudyPlans.weekStartDate))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(1);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return plan;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createWeeklyStudyPlan(plan: InsertWeeklyStudyPlan): Promise<WeeklyStudyPlan> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [created] = await db.insert(weeklyStudyPlans).values(plan).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return created;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateWeeklyStudyPlan(id: number, data: Partial<WeeklyStudyPlan>): Promise<WeeklyStudyPlan | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db.update(weeklyStudyPlans)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ ...data, updatedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(weeklyStudyPlans.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async completeWeeklyPlan(id: number): Promise<WeeklyStudyPlan | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db.update(weeklyStudyPlans)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ 

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        status: 'completed',

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
        updatedAt: new Date()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(weeklyStudyPlans.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async generateWeeklyAiRecommendations(userId: number, planId: number): Promise<string> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return "AI recommendations feature requires OpenAI API key configuration. Placeholder recommendations returned.";

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // AI Concept Logs implementation

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createAiConceptLog(log: InsertAiConceptLog): Promise<AiConceptLog> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newLog] = await db.insert(aiConceptLogs).values(log).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newLog;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAiConceptLogs(userId: number, limit: number = 50): Promise<AiConceptLog[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(aiConceptLogs)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(aiConceptLogs.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(aiConceptLogs.createdAt))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(limit);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateAiConceptLog(id: number, data: Partial<AiConceptLog>): Promise<AiConceptLog | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(aiConceptLogs)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(aiConceptLogs.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // AI Study Tips Logs implementation

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createAiStudyTipsLog(log: InsertAiStudyTipsLog): Promise<AiStudyTipsLog> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newLog] = await db.insert(aiStudyTipsLogs).values(log).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newLog;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAiStudyTipsLogs(userId: number, limit: number = 50): Promise<AiStudyTipsLog[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(aiStudyTipsLogs)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(aiStudyTipsLogs.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(aiStudyTipsLogs.createdAt))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(limit);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateAiStudyTipsLog(id: number, data: Partial<AiStudyTipsLog>): Promise<AiStudyTipsLog | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(aiStudyTipsLogs)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(aiStudyTipsLogs.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // AI Review Logs implementation

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createAiReviewLog(log: InsertAiReviewLog): Promise<AiReviewLog> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [newLog] = await db.insert(aiReviewLogs).values(log).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return newLog;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getAiReviewLogs(userId: number, limit: number = 50): Promise<AiReviewLog[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .select()

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .from(aiReviewLogs)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(aiReviewLogs.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(aiReviewLogs.createdAt))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(limit);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateAiReviewLog(id: number, data: Partial<AiReviewLog>): Promise<AiReviewLog | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .update(aiReviewLogs)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set(data)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(aiReviewLogs.id, id))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Step 6.1: AI Curriculum Generation Sessions

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async createAiGenerationSession(session: any): Promise<any> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [created] = await db.insert(aiCurriculumGenerationSessions).values(session).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return created;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getGenerationSession(sessionId: string): Promise<any | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [session] = await db.select().from(aiCurriculumGenerationSessions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(aiCurriculumGenerationSessions.sessionId, sessionId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return session;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getUserGenerationSessions(userId: number, limit: number = 50): Promise<any[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db.select().from(aiCurriculumGenerationSessions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(aiCurriculumGenerationSessions.userId, userId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(aiCurriculumGenerationSessions.startedAt))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .limit(limit);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async updateGenerationSession(sessionId: string, data: any): Promise<any | undefined> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [updated] = await db.update(aiCurriculumGenerationSessions)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .set({ ...data, completedAt: new Date() })

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(aiCurriculumGenerationSessions.sessionId, sessionId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return updated;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // Curriculum Production Archives

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async archiveProduction(archive: any): Promise<any> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [created] = await db.insert(curriculumProductionArchives).values(archive).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return created;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getProductionArchives(productionId: number): Promise<any[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db.select().from(curriculumProductionArchives)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(curriculumProductionArchives.productionId, productionId))

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .orderBy(desc(curriculumProductionArchives.archivedAt));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async deleteExpiredArchives(daysThreshold: number = 90): Promise<number> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const expiryDate = new Date(Date.now() - daysThreshold * 24 * 60 * 60 * 1000);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const result = await db.delete(curriculumProductionArchives)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(sql`${curriculumProductionArchives.archivedAt} < ${expiryDate}`);

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return result.rowCount || 0;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  // AI Learning Data

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async saveLearningData(learningData: any): Promise<any> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    const [created] = await db.insert(aiLearningData).values(learningData).returning();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return created;

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  }

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }


  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
  async getLearningDataBySession(sessionId: number): Promise<any[]> {

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
    return await db.select().from(aiLearningData)

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
      .where(eq(aiLearningData.generationSessionId, sessionId));

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
export const storage = new DatabaseStorage();

  // Feedback Loop Operations
  async createFeedbackLoop(loop: any): Promise<any> {
    const [created] = await db.insert(curriculumFeedbackLoops).values(loop).returning();
    return created;
  }

  async getFeedbackLoops(designId: number): Promise<any[]> {
    return db.select().from(curriculumFeedbackLoops)
      .where(eq(curriculumFeedbackLoops.designId, designId))
      .orderBy(desc(curriculumFeedbackLoops.cycleNumber));
  }

  async updateFeedbackLoop(id: number, updates: any): Promise<any> {
    const [updated] = await db.update(curriculumFeedbackLoops)
      .set(updates)
      .where(eq(curriculumFeedbackLoops.id, id))
      .returning();
    return updated;
  }
